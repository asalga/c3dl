<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"> <style>
	.KEYW {color: #933;}
	.COMM {color: #bbb; font-style: italic;}
	.NUMB {color: #393;}
	.STRN {color: #393;}
	.REGX {color: #339;}
	.line {border-right: 1px dotted #666; color: #666; font-style: normal;}
	</style></head><body><pre><span class='line'>  1</span> <span class="COMM">/*
<span class='line'>  2</span>   Copyright (c) 2008 Seneca College
<span class='line'>  3</span>   Licenced under the MIT License (http://www.c3dl.org/index.php/mit-license/)
<span class='line'>  4</span> */</span><span class="WHIT">
<span class='line'>  5</span> 
<span class='line'>  6</span> </span><span class="COMM">/**
<span class='line'>  7</span> 	@private
<span class='line'>  8</span> 	
<span class='line'>  9</span> 	class ColladaLoader is used by the ModelManager to load .DAE (COLLADA) files.
<span class='line'> 10</span> */</span><span class="WHIT">
<span class='line'> 11</span> </span><span class="NAME">c3dl.ColladaLoader</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'> 12</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 13</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">XHR_STATE_COMPLETED</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">4</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 14</span> 
<span class='line'> 15</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">xmlhttp</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 16</span> </span><span class="WHIT">	</span><span class="NAME">this.done</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 17</span> </span><span class="WHIT">	</span><span class="NAME">this.name</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="STRN">""</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 18</span> </span><span class="WHIT">	</span><span class="NAME">this.rootNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">c3dl.SceneNode</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 19</span> 
<span class='line'> 20</span> </span><span class="WHIT">	</span><span class="COMM">/**
<span class='line'> 21</span> 		@private
<span class='line'> 22</span> 		Opens the DAE file, reads the vertex, normal and uv data and stores 
<span class='line'> 23</span> 		all the data in 'expanded' form into members.
<span class='line'> 24</span> 		
<span class='line'> 25</span> 		@param {String} relativePath
<span class='line'> 26</span> 		@param {c3dl.SceneNode} rootNode
<span class='line'> 27</span> 	*/</span><span class="WHIT">
<span class='line'> 28</span> </span><span class="WHIT">	</span><span class="NAME">this.load</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">relativePath</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">rootNode</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'> 29</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 30</span> </span><span class="WHIT">		</span><span class="COMM">//</span><span class="WHIT">
<span class='line'> 31</span> </span><span class="WHIT">		</span><span class="NAME">this.rootNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">rootNode</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 32</span> 
<span class='line'> 33</span> </span><span class="WHIT">		</span><span class="NAME">xmlhttp</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">XMLHttpRequest</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 34</span> </span><span class="WHIT">		
<span class='line'> 35</span> 		</span><span class="COMM">//</span><span class="WHIT">
<span class='line'> 36</span> </span><span class="WHIT">		</span><span class="NAME">xmlhttp.parent</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">this</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 37</span> 
<span class='line'> 38</span> </span><span class="WHIT">		</span><span class="COMM">// call the parse function when XMLHttpRequest is ready.</span><span class="WHIT">
<span class='line'> 39</span> </span><span class="WHIT">		</span><span class="NAME">xmlhttp.callbackFunc</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.parse</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 40</span> </span><span class="WHIT">		</span><span class="NAME">xmlhttp.open</span><span class="PUNC">(</span><span class="STRN">"GET"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">relativePath</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 41</span> </span><span class="WHIT">		</span><span class="NAME">xmlhttp.overrideMimeType</span><span class="PUNC">(</span><span class="STRN">'text/xml'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 42</span> 
<span class='line'> 43</span> </span><span class="WHIT">		</span><span class="COMM">// this may throw an exception if the file isn't found, so </span><span class="WHIT">
<span class='line'> 44</span> </span><span class="WHIT">		</span><span class="COMM">// catch the exception and give the user a helpful warning message.</span><span class="WHIT">
<span class='line'> 45</span> </span><span class="WHIT">		</span><span class="KEYW">try</span><span class="WHIT">
<span class='line'> 46</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 47</span> </span><span class="WHIT">			</span><span class="COMM">// send the request</span><span class="WHIT">
<span class='line'> 48</span> </span><span class="WHIT">			</span><span class="NAME">xmlhttp.send</span><span class="PUNC">(</span><span class="KEYW">null</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 49</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'> 50</span> </span><span class="WHIT">		</span><span class="KEYW">catch</span><span class="PUNC">(</span><span class="NAME">err</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'> 51</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 52</span> </span><span class="WHIT">			</span><span class="NAME">c3dl.debug.logWarning</span><span class="PUNC">(</span><span class="STRN">"Could not find file '"</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">relativePath</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="STRN">"'. Check the path."</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 53</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'> 54</span> 
<span class='line'> 55</span> </span><span class="WHIT">		</span><span class="COMM">/**
<span class='line'> 56</span> 			@private
<span class='line'> 57</span> 		*/</span><span class="WHIT">
<span class='line'> 58</span> </span><span class="WHIT">		</span><span class="NAME">xmlhttp.onreadystatechange</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'> 59</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 60</span> </span><span class="WHIT">			</span><span class="COMM">// when the state has changed to being finished, </span><span class="WHIT">
<span class='line'> 61</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">xmlhttp.readyState</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">XHR_STATE_COMPLETED</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'> 62</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 63</span> </span><span class="WHIT">				</span><span class="COMM">// this line may not be totally nnecessary.</span><span class="WHIT">
<span class='line'> 64</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">xmlhttp.responseXML</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'> 65</span> </span><span class="WHIT">				</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 66</span> </span><span class="WHIT">					</span><span class="NAME">xmlhttp.responseXML.colladaPath</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">relativePath</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 67</span> 
<span class='line'> 68</span> </span><span class="WHIT">					</span><span class="COMM">// we can now parse by calling the callback which </span><span class="WHIT">
<span class='line'> 69</span> </span><span class="WHIT">					</span><span class="COMM">// was set the the parse function.</span><span class="WHIT">
<span class='line'> 70</span> </span><span class="WHIT">					</span><span class="NAME">this.callbackFunc</span><span class="PUNC">(</span><span class="NAME">xmlhttp.responseXML</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 71</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'> 72</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'> 73</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'> 74</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'> 75</span> 
<span class='line'> 76</span> </span><span class="WHIT">	
<span class='line'> 77</span> 	</span><span class="COMM">/**
<span class='line'> 78</span> 		@private
<span class='line'> 79</span> 
<span class='line'> 80</span> 		Parse a node from the DAE file.  The part of the DAE file
<span class='line'> 81</span> 		we are interested with is the scenegraph which is a hierarchical
<span class='line'> 82</span> 		structure of nodes.  Nodes therefore can contain other nodes, thus
<span class='line'> 83</span> 		we use a recursive function to parse each one.
<span class='line'> 84</span> 
<span class='line'> 85</span> 		// clarify nodes in sg nodes in _DOM_
<span class='line'> 86</span> 		@param {xmlDocument} xmlObject The DAE DOM.
<span class='line'> 87</span> 		@param {} node The node element to parse. the DOM
<span class='line'> 88</span> 		@param {c3dl.SceneNode} sgNode The SceneGraph node, not part of the XML DOM.
<span class='line'> 89</span> 	*/</span><span class="WHIT">
<span class='line'> 90</span> </span><span class="WHIT">	</span><span class="NAME">this.parseNodeRecursive</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">xmlObject</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">node</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">sgNode</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'> 91</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 92</span> </span><span class="WHIT">		</span><span class="COMM">// set this node's transform</span><span class="WHIT">
<span class='line'> 93</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">translateTag</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">c3dl.ColladaLoader.getChildNodesByNodeName</span><span class="PUNC">(</span><span class="NAME">node</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"translate"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 94</span> 
<span class='line'> 95</span> </span><span class="WHIT">		</span><span class="COMM">// node may not have one, so check first</span><span class="WHIT">
<span class='line'> 96</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">translateTag</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'> 97</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 98</span> </span><span class="WHIT">			</span><span class="COMM">// string representation of data between &lt;translate> tags.</span><span class="WHIT">
<span class='line'> 99</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">floatValues</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">c3dl.ColladaLoader.stringsToFloats</span><span class="PUNC">(</span><span class="NAME">translateTag</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">childNodes</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">nodeValue</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">' '</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>100</span> </span><span class="WHIT">			</span><span class="NAME">sgNode.translate</span><span class="PUNC">(</span><span class="NAME">floatValues</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>101</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>102</span> 
<span class='line'>103</span> </span><span class="WHIT">		</span><span class="COMM">// rotations</span><span class="WHIT">
<span class='line'>104</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">rotationTags</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">c3dl.ColladaLoader.getChildNodesByNodeName</span><span class="PUNC">(</span><span class="NAME">node</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"rotate"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>105</span> </span><span class="WHIT">		
<span class='line'>106</span> 		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">rotationTags</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>107</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>108</span> </span><span class="WHIT">			</span><span class="COMM">// example</span><span class="WHIT">
<span class='line'>109</span> </span><span class="WHIT">			</span><span class="COMM">// &lt;rotate sid="rotateZ">0 0 1 15&lt;/rotate></span><span class="WHIT">
<span class='line'>110</span> </span><span class="WHIT">			</span><span class="COMM">// &lt;rotate sid="rotateY">0 1 0 0&lt;/rotate></span><span class="WHIT">
<span class='line'>111</span> </span><span class="WHIT">			</span><span class="COMM">// &lt;rotate sid="rotateX">1 0 0 0&lt;/rotate></span><span class="WHIT">
<span class='line'>112</span> </span><span class="WHIT">			</span><span class="KEYW">for</span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">rotationTags.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>113</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>114</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">floatValues</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">c3dl.ColladaLoader.stringsToFloats</span><span class="PUNC">(</span><span class="NAME">rotationTags</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">childNodes</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">nodeValue</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">' '</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>115</span> 
<span class='line'>116</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">vec</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="NAME">floatValues</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">floatValues</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="NAME">floatValues</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>117</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">angle</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">c3dl.degreesToRadians</span><span class="PUNC">(</span><span class="NAME">floatValues</span><span class="PUNC">[</span><span class="NUMB">3</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>118</span> 
<span class='line'>119</span> </span><span class="WHIT">				</span><span class="NAME">sgNode.rotateOnAxis</span><span class="PUNC">(</span><span class="NAME">vec</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">angle</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>120</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>121</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>122</span> 
<span class='line'>123</span> </span><span class="WHIT">		</span><span class="COMM">// &lt;scale> tag</span><span class="WHIT">
<span class='line'>124</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">scaleTag</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">c3dl.ColladaLoader.getChildNodesByNodeName</span><span class="PUNC">(</span><span class="NAME">node</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"scale"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>125</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">scaleTag</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>126</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>127</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">floatValues</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">c3dl.ColladaLoader.stringsToFloats</span><span class="PUNC">(</span><span class="NAME">scaleTag</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">childNodes</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">nodeValue</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">' '</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>128</span> </span><span class="WHIT">			</span><span class="NAME">sgNode.scale</span><span class="PUNC">(</span><span class="NAME">floatValues</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>129</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>130</span> </span><span class="WHIT">		
<span class='line'>131</span> 		</span><span class="COMM">// &lt;matrix> tag specifies the matrix of the node instead of</span><span class="WHIT">
<span class='line'>132</span> </span><span class="WHIT">		</span><span class="COMM">// a scale, translate and rotate.  </span><span class="WHIT">
<span class='line'>133</span> </span><span class="WHIT">		</span><span class="COMM">//</span><span class="WHIT">
<span class='line'>134</span> </span><span class="WHIT">		</span><span class="COMM">//  The set of 16 numbers can have values with leading or trailing spaces, so we have to </span><span class="WHIT">
<span class='line'>135</span> </span><span class="WHIT">		</span><span class="COMM">// </span><span class="WHIT">
<span class='line'>136</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">matrixTag</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">c3dl.ColladaLoader.getChildNodesByNodeName</span><span class="PUNC">(</span><span class="NAME">node</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"matrix"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>137</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">matrixTag</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>138</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>139</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">floatValues</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">c3dl.ColladaLoader.stringsToFloats</span><span class="PUNC">(</span><span class="NAME">matrixTag</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">childNodes</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">nodeValue</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">' '</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>140</span> </span><span class="WHIT">			</span><span class="NAME">sgNode.setTransform</span><span class="PUNC">(</span><span class="NAME">c3dl.transposeMatrix</span><span class="PUNC">(</span><span class="NAME">floatValues</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>141</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>142</span> </span><span class="WHIT">		
<span class='line'>143</span> 
<span class='line'>144</span> 		</span><span class="COMM">// At this point, this node's child nodes have been parsed or it</span><span class="WHIT">
<span class='line'>145</span> </span><span class="WHIT">		</span><span class="COMM">// did not contain subnodes.</span><span class="WHIT">
<span class='line'>146</span> </span><span class="WHIT">		
<span class='line'>147</span> 		</span><span class="COMM">// get the geometryNodes of this node.</span><span class="WHIT">
<span class='line'>148</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">geometries</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">c3dl.ColladaLoader.getChildNodesByNodeName</span><span class="PUNC">(</span><span class="NAME">node</span><span class="PUNC">,</span><span class="STRN">"instance_geometry"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>149</span> 
<span class='line'>150</span> </span><span class="WHIT">		</span><span class="COMM">// base case: we found a geometry leaf node, now instantiate it.</span><span class="WHIT">
<span class='line'>151</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">geometries</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>152</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>153</span> </span><span class="WHIT">			</span><span class="COMM">// a node may contain many geometryNodes, so we have to create each one.</span><span class="WHIT">
<span class='line'>154</span> </span><span class="WHIT">			</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currGeo</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currGeo</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">geometries.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currGeo</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>155</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>156</span> </span><span class="WHIT">				</span><span class="COMM">// the url references a &lt;geometry> element within the &lt;library_geometry></span><span class="WHIT">
<span class='line'>157</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">url</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">geometries</span><span class="PUNC">[</span><span class="NAME">currGeo</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="STRN">"url"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">split</span><span class="PUNC">(</span><span class="STRN">'#'</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>158</span> </span><span class="WHIT">			
<span class='line'>159</span> 				</span><span class="COMM">// A separate function exists to actually create the geometry which can</span><span class="WHIT">
<span class='line'>160</span> </span><span class="WHIT">				</span><span class="COMM">// be pretty messy going through the DOM and constructing the geometry.</span><span class="WHIT">
<span class='line'>161</span> </span><span class="WHIT">				</span><span class="NAME">sgNode.addChild</span><span class="PUNC">(</span><span class="NAME">this.instantiateGeometry</span><span class="PUNC">(</span><span class="NAME">xmlObject</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">url</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">geometries</span><span class="PUNC">[</span><span class="NAME">currGeo</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>162</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>163</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>164</span> </span><span class="WHIT">		
<span class='line'>165</span> 		</span><span class="COMM">//</span><span class="WHIT">
<span class='line'>166</span> </span><span class="WHIT">		</span><span class="COMM">// &lt;instance_node> appears after &lt;instance_geometry></span><span class="WHIT">
<span class='line'>167</span> </span><span class="WHIT">		</span><span class="COMM">//</span><span class="WHIT">
<span class='line'>168</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">instance_nodes</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">c3dl.ColladaLoader.getChildNodesByNodeName</span><span class="PUNC">(</span><span class="NAME">node</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"instance_node"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>169</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">instance_nodes</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>170</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">	
<span class='line'>171</span> 			</span><span class="COMM">// a &lt;node> can contain 0..N &lt;instance_node> so iterate over each one</span><span class="WHIT">
<span class='line'>172</span> </span><span class="WHIT">			</span><span class="KEYW">for</span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currNode</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">instance_nodes.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currNode</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>173</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>174</span> </span><span class="WHIT">				</span><span class="COMM">// remove the '#' from the url</span><span class="WHIT">
<span class='line'>175</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">url</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">instance_nodes</span><span class="PUNC">[</span><span class="NAME">currNode</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="STRN">"url"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">split</span><span class="PUNC">(</span><span class="STRN">'#'</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>176</span> </span><span class="WHIT">				</span><span class="NAME">sgNode.addChild</span><span class="PUNC">(</span><span class="NAME">this.instantiateNode</span><span class="PUNC">(</span><span class="NAME">xmlObject</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">url</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>177</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>178</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>179</span> </span><span class="WHIT">				
<span class='line'>180</span> 		
<span class='line'>181</span> 		</span><span class="COMM">// get the DIRECT child nodes of this node.  We can't use</span><span class="WHIT">
<span class='line'>182</span> </span><span class="WHIT">		</span><span class="COMM">// getElementsByTagName since its recursive and will</span><span class="WHIT">
<span class='line'>183</span> </span><span class="WHIT">		</span><span class="COMM">// return this node's grandchildren, we don't want that. </span><span class="WHIT">
<span class='line'>184</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">nodes</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">c3dl.ColladaLoader.getChildNodesByNodeName</span><span class="PUNC">(</span><span class="NAME">node</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"node"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>185</span> </span><span class="WHIT">		
<span class='line'>186</span> 		</span><span class="COMM">// recursive case: the node has one or many nodes, therefore</span><span class="WHIT">
<span class='line'>187</span> </span><span class="WHIT">		</span><span class="COMM">// we have to parse all of its nodes.</span><span class="WHIT">
<span class='line'>188</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">nodes</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>189</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>190</span> </span><span class="WHIT">			</span><span class="COMM">// for each of subnodes, call this function.</span><span class="WHIT">
<span class='line'>191</span> </span><span class="WHIT">			</span><span class="KEYW">for</span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">nodes.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>192</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>193</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">scenenode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">c3dl.SceneNode</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>194</span> </span><span class="WHIT">				</span><span class="NAME">scenenode.setName</span><span class="PUNC">(</span><span class="NAME">nodes</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="STRN">"name"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>195</span> </span><span class="WHIT">				</span><span class="NAME">sgNode.addChild</span><span class="PUNC">(</span><span class="NAME">scenenode</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>196</span> 
<span class='line'>197</span> </span><span class="WHIT">				</span><span class="COMM">// call this function for each of the nodes found.</span><span class="WHIT">
<span class='line'>198</span> </span><span class="WHIT">				</span><span class="NAME">this.parseNodeRecursive</span><span class="PUNC">(</span><span class="NAME">xmlObject</span><span class="PUNC">,</span><span class="NAME">nodes</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="NAME">scenenode</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>199</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>200</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>201</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>202</span> </span><span class="WHIT">	
<span class='line'>203</span> 	</span><span class="COMM">/**
<span class='line'>204</span> 		@private
<span class='line'>205</span> 
<span class='line'>206</span> 		Get the child element of a parent element in the scenario when a schema can 
<span class='line'>207</span> 		have only one of set of children. For example, the technique element in the 
<span class='line'>208</span> 		common profile can have either constant, lambert, phong or blinn child elements
<span class='line'>209</span> 		which are mutually exclusive.
<span class='line'>210</span> 
<span class='line'>211</span> 		@returns {object Element}
<span class='line'>212</span> 			
<span class='line'>213</span> 		@param {Array} choiceTagNames Array of strings which contain the tags of
<span class='line'>214</span> 		choices an element can have.
<span class='line'>215</span> 	*/</span><span class="WHIT">
<span class='line'>216</span> </span><span class="WHIT">	</span><span class="NAME">this.getChoice</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">parentTag</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">choiceTagNames</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>217</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">		
<span class='line'>218</span> 		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">choice</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>219</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>220</span> </span><span class="WHIT">		
<span class='line'>221</span> 		</span><span class="COMM">// use an iterator just in case the file does not conform to the spec</span><span class="WHIT">
<span class='line'>222</span> </span><span class="WHIT">		</span><span class="COMM">// and we can just out of the loop</span><span class="WHIT">
<span class='line'>223</span> </span><span class="WHIT">		</span><span class="KEYW">while</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">choice</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="WHIT"> </span><span class="PUNC">&&</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">choiceTagNames.length</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>224</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>225</span> </span><span class="WHIT">			</span><span class="NAME">choice</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parentTag.getElementsByTagName</span><span class="PUNC">(</span><span class="NAME">choiceTagNames</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>226</span> </span><span class="WHIT">			</span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>227</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>228</span> 
<span class='line'>229</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">choice</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>230</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>231</span> 
<span class='line'>232</span> </span><span class="WHIT">	</span><span class="COMM">/**
<span class='line'>233</span> 		@private
<span class='line'>234</span> 		Parse is responsible for traversing different parts of the xmlObject
<span class='line'>235</span> 		and constructing the geometries from the data provided.
<span class='line'>236</span> 		
<span class='line'>237</span> 		This function is not called directly, it is called once the xml is 
<span class='line'>238</span> 		finished downloading.
<span class='line'>239</span> 		
<span class='line'>240</span> 		@param {xmlDocument} xmlObject
<span class='line'>241</span> 	*/</span><span class="WHIT">
<span class='line'>242</span> </span><span class="WHIT">	</span><span class="NAME">this.parse</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">xmlObject</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>243</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>244</span> </span><span class="WHIT">		</span><span class="COMM">// since the xmlhttp object is calling this function, any reference</span><span class="WHIT">
<span class='line'>245</span> </span><span class="WHIT">		</span><span class="COMM">// to 'this' refers to the xmlhttp object, but we want to access the members in</span><span class="WHIT">
<span class='line'>246</span> </span><span class="WHIT">		</span><span class="COMM">// the object that owns this function, the DAELoader instance.  To</span><span class="WHIT">
<span class='line'>247</span> </span><span class="WHIT">		</span><span class="COMM">// do this, simply make a reference to the this.parent which was set</span><span class="WHIT">
<span class='line'>248</span> </span><span class="WHIT">		</span><span class="COMM">// earlier, now we can access the members we need.</span><span class="WHIT">
<span class='line'>249</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">loader</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.parent</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>250</span> </span><span class="WHIT">		
<span class='line'>251</span> 		</span><span class="COMM">// get the root element of the xml document, to keep the naming short.</span><span class="WHIT">
<span class='line'>252</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">root</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">xmlObject.documentElement</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>253</span> 
<span class='line'>254</span> </span><span class="WHIT">		</span><span class="COMM">// load the images listed in the dae file under the</span><span class="WHIT">
<span class='line'>255</span> </span><span class="WHIT">		</span><span class="COMM">// library_images into the texture manager.</span><span class="WHIT">
<span class='line'>256</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">library_images</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">root.getElementsByTagName</span><span class="PUNC">(</span><span class="STRN">"library_images"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>257</span> </span><span class="WHIT">		
<span class='line'>258</span> 		</span><span class="COMM">// &lt;collada> may have 0 or many &lt;library_images></span><span class="WHIT">
<span class='line'>259</span> </span><span class="WHIT">		</span><span class="KEYW">for</span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">libraryImagesIter</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">libraryImagesIter</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">library_images.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">libraryImagesIter</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>260</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>261</span> </span><span class="WHIT">			</span><span class="COMM">// one &lt;library_images> has &lt;images>. cardinality isn't mentioned in the spec.</span><span class="WHIT">
<span class='line'>262</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">imageElements</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">library_images</span><span class="PUNC">[</span><span class="NAME">libraryImagesIter</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getElementsByTagName</span><span class="PUNC">(</span><span class="STRN">"image"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>263</span> </span><span class="WHIT">		
<span class='line'>264</span> 			</span><span class="COMM">// </span><span class="WHIT">
<span class='line'>265</span> </span><span class="WHIT">			</span><span class="KEYW">for</span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">imageElementIter</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">imageElementIter</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">imageElements.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">imageElementIter</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>266</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>267</span> </span><span class="WHIT">				</span><span class="COMM">// an &lt;image> has exactly one &lt;init_from> which have the uri or the</span><span class="WHIT">
<span class='line'>268</span> </span><span class="WHIT">				</span><span class="COMM">// texture.</span><span class="WHIT">
<span class='line'>269</span> </span><span class="WHIT">				</span><span class="COMM">//	&lt;image id="file2" name="file2" depth="1"></span><span class="WHIT">
<span class='line'>270</span> </span><span class="WHIT">				</span><span class="COMM">//		&lt;init_from>./duckCM.tga&lt;/init_from></span><span class="WHIT">
<span class='line'>271</span> </span><span class="WHIT">				</span><span class="COMM">//	&lt;/image></span><span class="WHIT">
<span class='line'>272</span> </span><span class="WHIT">				</span><span class="COMM">//</span><span class="WHIT">
<span class='line'>273</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">init_from</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">imageElements</span><span class="PUNC">[</span><span class="NAME">imageElementIter</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getElementsByTagName</span><span class="PUNC">(</span><span class="STRN">"init_from"</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>274</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>275</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>276</span> 
<span class='line'>277</span> </span><span class="WHIT">		</span><span class="COMM">// we start at the scene tag. A document instance </span><span class="WHIT">
<span class='line'>278</span> </span><span class="WHIT">		</span><span class="COMM">// can contain zero or 1 &lt;scene> tags, therefore we</span><span class="WHIT">
<span class='line'>279</span> </span><span class="WHIT">		</span><span class="COMM">// can address the 0th element.  If the</span><span class="WHIT">
<span class='line'>280</span> </span><span class="WHIT">		</span><span class="COMM">// scene tag is not present, this is an error, as </span><span class="WHIT">
<span class='line'>281</span> </span><span class="WHIT">		</span><span class="COMM">// we are concerned with some sort of visual scene.</span><span class="WHIT">
<span class='line'>282</span> </span><span class="WHIT">		</span><span class="COMM">// TODO: handle no scene elements.</span><span class="WHIT">
<span class='line'>283</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">sceneElement</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">root.getElementsByTagName</span><span class="PUNC">(</span><span class="STRN">"scene"</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>284</span> 
<span class='line'>285</span> </span><span class="WHIT">		</span><span class="COMM">// A scene element can contain ZERO OR ONE of each of the following </span><span class="WHIT">
<span class='line'>286</span> </span><span class="WHIT">		</span><span class="COMM">// elements:</span><span class="WHIT">
<span class='line'>287</span> </span><span class="WHIT">		</span><span class="COMM">// &lt;instance_visual_scene></span><span class="WHIT">
<span class='line'>288</span> </span><span class="WHIT">		</span><span class="COMM">// &lt;instance_physics_scene></span><span class="WHIT">
<span class='line'>289</span> </span><span class="WHIT">		</span><span class="COMM">// again, we are concerned only with visual stuff right now</span><span class="WHIT">
<span class='line'>290</span> </span><span class="WHIT">		</span><span class="COMM">// so if the element &lt;instance_visual_scene> is not present, </span><span class="WHIT">
<span class='line'>291</span> </span><span class="WHIT">		</span><span class="COMM">// its another error. the &lt;instance_visual_scene> has an attribute that acts as</span><span class="WHIT">
<span class='line'>292</span> </span><span class="WHIT">		</span><span class="COMM">// a foreign key into an element in the library_visual_scenes</span><span class="WHIT">
<span class='line'>293</span> </span><span class="WHIT">		</span><span class="COMM">// tag.</span><span class="WHIT">
<span class='line'>294</span> </span><span class="WHIT">		</span><span class="COMM">// TODO: handle no &lt;instance_visual_scene> element. This can occur if the</span><span class="WHIT">
<span class='line'>295</span> </span><span class="WHIT">		</span><span class="COMM">// user tries to load a 1.3 Collada instance.</span><span class="WHIT">
<span class='line'>296</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">instanceVisualSceneElem</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">sceneElement.getElementsByTagName</span><span class="PUNC">(</span><span class="STRN">"instance_visual_scene"</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>297</span> 
<span class='line'>298</span> </span><span class="WHIT">		</span><span class="COMM">// get the url attribute of the &lt;instance_visual_scene></span><span class="WHIT">
<span class='line'>299</span> </span><span class="WHIT">		</span><span class="COMM">// this will tell us which scene to load. (we will be loading one scene from the </span><span class="WHIT">
<span class='line'>300</span> </span><span class="WHIT">		</span><span class="COMM">// library of scenes).</span><span class="WHIT">
<span class='line'>301</span> </span><span class="WHIT">		</span><span class="COMM">// this has a # in front of it so we have to remove it.</span><span class="WHIT">
<span class='line'>302</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">visualSceneToLoad</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">instanceVisualSceneElem.getAttribute</span><span class="PUNC">(</span><span class="STRN">"url"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">split</span><span class="PUNC">(</span><span class="STRN">'#'</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>303</span> 
<span class='line'>304</span> </span><span class="WHIT">		</span><span class="COMM">// a collada document has ZERO OR MANY &lt;library_visual_scenes></span><span class="WHIT">
<span class='line'>305</span> </span><span class="WHIT">		</span><span class="COMM">// which in turn have ONE OR MANY &lt;visual_scene>'s.</span><span class="WHIT">
<span class='line'>306</span> </span><span class="WHIT">		</span><span class="COMM">// a &lt;visual_scene> is the base of a scenegraph, which is what we </span><span class="WHIT">
<span class='line'>307</span> </span><span class="WHIT">		</span><span class="COMM">// want.  Note that even if &lt;library_visual_scenes> has</span><span class="WHIT">
<span class='line'>308</span> </span><span class="WHIT">		</span><span class="COMM">// more than one &lt;visual_scene>'s, only one will be loaded.</span><span class="WHIT">
<span class='line'>309</span> </span><span class="WHIT">		</span><span class="COMM">// The one to load is the the value found earlier in the </span><span class="WHIT">
<span class='line'>310</span> </span><span class="WHIT">		</span><span class="COMM">// &lt;instance_visual_scene>'s url attribute.</span><span class="WHIT">
<span class='line'>311</span> </span><span class="WHIT">		</span><span class="COMM">// so first, go the the collada's/root's &lt;library_visual_scenes></span><span class="WHIT">
<span class='line'>312</span> </span><span class="WHIT">		</span><span class="COMM">// TODO: can't access the first node since there may be many library_visual_scenes,</span><span class="WHIT">
<span class='line'>313</span> </span><span class="WHIT">		</span><span class="COMM">// we have to iterate over the libraries until we find the visualScene we want.</span><span class="WHIT">
<span class='line'>314</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">libraryVisualScenes</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">root.getElementsByTagName</span><span class="PUNC">(</span><span class="STRN">"library_visual_scenes"</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>315</span> 
<span class='line'>316</span> </span><span class="WHIT">		</span><span class="COMM">// added 'List' to avoid confusion with 'visualScene', which is the</span><span class="WHIT">
<span class='line'>317</span> </span><span class="WHIT">		</span><span class="COMM">// scene we will load.</span><span class="WHIT">
<span class='line'>318</span> </span><span class="WHIT">		</span><span class="COMM">// This is the list of visual scenes.  Only one of which we will actually load.</span><span class="WHIT">
<span class='line'>319</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">visualSceneList</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">libraryVisualScenes.getElementsByTagName</span><span class="PUNC">(</span><span class="STRN">"visual_scene"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>320</span> 
<span class='line'>321</span> </span><span class="WHIT">		</span><span class="COMM">// Find the &lt;visual_scene> element which we want, buy</span><span class="WHIT">
<span class='line'>322</span> </span><span class="WHIT">		</span><span class="COMM">// using the 'foreign key' we got from the &lt;instance_visual_scene>.</span><span class="WHIT">
<span class='line'>323</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">visualScene</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>324</span> 
<span class='line'>325</span> </span><span class="WHIT">		</span><span class="COMM">// go over all the visual scenes trying to identify the one we want.</span><span class="WHIT">
<span class='line'>326</span> </span><span class="WHIT">		</span><span class="KEYW">for</span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">visualSceneList.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>327</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>328</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">visualSceneList</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="STRN">"id"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">visualSceneToLoad</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>329</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>330</span> </span><span class="WHIT">				</span><span class="NAME">visualScene</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">visualSceneList</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>331</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>332</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>333</span> 
<span class='line'>334</span> </span><span class="WHIT">		</span><span class="COMM">// we are at the start of the visual_scene tag, this may have many</span><span class="WHIT">
<span class='line'>335</span> </span><span class="WHIT">		</span><span class="COMM">// nodes</span><span class="WHIT">
<span class='line'>336</span> 
<span class='line'>337</span> </span><span class="WHIT">		</span><span class="COMM">// we now should have the visual_scene to load.</span><span class="WHIT">
<span class='line'>338</span> </span><span class="WHIT">		</span><span class="COMM">// A visual scene has ONE OR MANY &lt;node> elements which compose the scenegraph.</span><span class="WHIT">
<span class='line'>339</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">nodes</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">c3dl.ColladaLoader.getChildNodesByNodeName</span><span class="PUNC">(</span><span class="NAME">visualScene</span><span class="PUNC">,</span><span class="STRN">"node"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>340</span> 
<span class='line'>341</span> </span><span class="WHIT">		</span><span class="COMM">// there is a change nodes is null if the dae file was edited manually</span><span class="WHIT">
<span class='line'>342</span> </span><span class="WHIT">		</span><span class="COMM">// and the nodes were removed. </span><span class="WHIT">
<span class='line'>343</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">nodes</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>344</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>345</span> </span><span class="WHIT">			</span><span class="COMM">// parse each of the 'root' nodes.</span><span class="WHIT">
<span class='line'>346</span> </span><span class="WHIT">			</span><span class="KEYW">for</span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currNode</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">nodes.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currNode</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>347</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>348</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">scenenode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">c3dl.SceneNode</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>349</span> </span><span class="WHIT">				
<span class='line'>350</span> 				</span><span class="COMM">//</span><span class="WHIT">
<span class='line'>351</span> </span><span class="WHIT">				</span><span class="NAME">loader.rootNode.addChild</span><span class="PUNC">(</span><span class="NAME">scenenode</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">	
<span class='line'>352</span> 				</span><span class="NAME">scenenode.setName</span><span class="PUNC">(</span><span class="NAME">nodes</span><span class="PUNC">[</span><span class="NAME">currNode</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="STRN">"name"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>353</span> 
<span class='line'>354</span> </span><span class="WHIT">				</span><span class="NAME">loader.parseNodeRecursive</span><span class="PUNC">(</span><span class="NAME">xmlObject</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">nodes</span><span class="PUNC">[</span><span class="NAME">currNode</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">scenenode</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>355</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>356</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>357</span> 
<span class='line'>358</span> </span><span class="WHIT">		</span><span class="COMM">// TODO: comment</span><span class="WHIT">
<span class='line'>359</span> </span><span class="WHIT">		</span><span class="NAME">c3dl.ColladaQueue.popFront</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>360</span> </span><span class="WHIT">		</span><span class="KEYW">delete</span><span class="WHIT"> </span><span class="NAME">xmlObject</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>361</span> </span><span class="WHIT">		</span><span class="KEYW">delete</span><span class="WHIT"> </span><span class="NAME">xmlhttp</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>362</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>363</span> 
<span class='line'>364</span> </span><span class="WHIT">	</span><span class="COMM">/**
<span class='line'>365</span> 	*/</span><span class="WHIT">
<span class='line'>366</span> </span><span class="WHIT">	
<span class='line'>367</span> 
<span class='line'>368</span> 	</span><span class="COMM">/**
<span class='line'>369</span> 		@private
<span class='line'>370</span> 
<span class='line'>371</span> 		@param {XMLDocument} xmlObject
<span class='line'>372</span> 		@param {String} target
<span class='line'>373</span> 	*/</span><span class="WHIT">
<span class='line'>374</span> </span><span class="WHIT">	</span><span class="NAME">this.instantiateMaterial</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">xmlObject</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">target</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>375</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>376</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">tempTexture</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>377</span> </span><span class="WHIT">		
<span class='line'>378</span> 		</span><span class="COMM">// we now have the material ID which we can look up in the library materials.</span><span class="WHIT">
<span class='line'>379</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">material</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.findElementInLibrary</span><span class="PUNC">(</span><span class="NAME">xmlObject</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"library_materials"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"material"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">target</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>380</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">tempName</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">target</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>381</span> </span><span class="WHIT">		
<span class='line'>382</span> 		</span><span class="COMM">// a &lt;material> has exactly 1 &lt;instance_effect>, so just get the first.</span><span class="WHIT">
<span class='line'>383</span> </span><span class="WHIT">		</span><span class="COMM">//</span><span class="WHIT">
<span class='line'>384</span> </span><span class="WHIT">		</span><span class="COMM">//&lt;library_materials></span><span class="WHIT">
<span class='line'>385</span> </span><span class="WHIT">		</span><span class="COMM">//	&lt;material id="shine" name="shine"></span><span class="WHIT">
<span class='line'>386</span> </span><span class="WHIT">		</span><span class="COMM">//		&lt;instance_effect url="#shine-fx"/></span><span class="WHIT">
<span class='line'>387</span> </span><span class="WHIT">		</span><span class="COMM">//	&lt;/material></span><span class="WHIT">
<span class='line'>388</span> </span><span class="WHIT">		</span><span class="COMM">//	&lt;material id="matte" name="matte"></span><span class="WHIT">
<span class='line'>389</span> </span><span class="WHIT">		</span><span class="COMM">//		&lt;instance_effect url="#matte-fx"/></span><span class="WHIT">
<span class='line'>390</span> </span><span class="WHIT">		</span><span class="COMM">//	&lt;/material></span><span class="WHIT">
<span class='line'>391</span> </span><span class="WHIT">		</span><span class="COMM">//&lt;/library_materials></span><span class="WHIT">
<span class='line'>392</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">instanceEffect</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">material.getElementsByTagName</span><span class="PUNC">(</span><span class="STRN">"instance_effect"</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>393</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">instanceEffectURL</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">instanceEffect.getAttribute</span><span class="PUNC">(</span><span class="STRN">"url"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">split</span><span class="PUNC">(</span><span class="STRN">'#'</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>394</span> 
<span class='line'>395</span> </span><span class="WHIT">		</span><span class="COMM">// go to the &lt;library_effects> since we have the &lt;instance_effect></span><span class="WHIT">
<span class='line'>396</span> </span><span class="WHIT">		</span><span class="COMM">// and it points to an entry in the library.</span><span class="WHIT">
<span class='line'>397</span> </span><span class="WHIT">		</span><span class="COMM">//</span><span class="WHIT">
<span class='line'>398</span> </span><span class="WHIT">		</span><span class="COMM">//</span><span class="WHIT">
<span class='line'>399</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">effect</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.findElementInLibrary</span><span class="PUNC">(</span><span class="NAME">xmlObject</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"library_effects"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"effect"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">instanceEffectURL</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>400</span> 
<span class='line'>401</span> </span><span class="WHIT">		</span><span class="COMM">// An effect has 1..N profiles. Each profile is designed for a specific platform,</span><span class="WHIT">
<span class='line'>402</span> </span><span class="WHIT">		</span><span class="COMM">// usage scenario, etc.</span><span class="WHIT">
<span class='line'>403</span> </span><span class="WHIT">		</span><span class="COMM">//</span><span class="WHIT">
<span class='line'>404</span> </span><span class="WHIT">		</span><span class="COMM">// profile types include:</span><span class="WHIT">
<span class='line'>405</span> </span><span class="WHIT">		</span><span class="COMM">// profile_COMMON - used for basic interchange between DCCs.</span><span class="WHIT">
<span class='line'>406</span> </span><span class="WHIT">		</span><span class="COMM">// profile_CG - opengl and NVIDIA's Cg shading language.</span><span class="WHIT">
<span class='line'>407</span> </span><span class="WHIT">		</span><span class="COMM">// profile_GLSL - opengl & glslang</span><span class="WHIT">
<span class='line'>408</span> </span><span class="WHIT">		</span><span class="COMM">// profile_GLES - opengl 1.0 and 1.1</span><span class="WHIT">
<span class='line'>409</span> </span><span class="WHIT">		</span><span class="COMM">//</span><span class="WHIT">
<span class='line'>410</span> </span><span class="WHIT">		</span><span class="COMM">// Collada book states support for GLES 2.0 and HLSL are in development,</span><span class="WHIT">
<span class='line'>411</span> </span><span class="WHIT">		</span><span class="COMM">// has this already been released?</span><span class="WHIT">
<span class='line'>412</span> </span><span class="WHIT">		</span><span class="COMM">//</span><span class="WHIT">
<span class='line'>413</span> </span><span class="WHIT">		</span><span class="COMM">// Right now we will focus on the fallback, profile_COMMON since it seems to be </span><span class="WHIT">
<span class='line'>414</span> </span><span class="WHIT">		</span><span class="COMM">// the safest profile and will likely be available. This should be understood </span><span class="WHIT">
<span class='line'>415</span> </span><span class="WHIT">		</span><span class="COMM">// by every application. We use it now as a default, later other profiles can </span><span class="WHIT">
<span class='line'>416</span> </span><span class="WHIT">		</span><span class="COMM">// be supported, namely GLSL/GLES.</span><span class="WHIT">
<span class='line'>417</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">profile_COMMON</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">effect.getElementsByTagName</span><span class="PUNC">(</span><span class="STRN">"profile_COMMON"</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>418</span> </span><span class="WHIT">		
<span class='line'>419</span> 		</span><span class="COMM">// In each technique in the profile_COMMON profile is one of the  shader </span><span class="WHIT">
<span class='line'>420</span> </span><span class="WHIT">		</span><span class="COMM">// algorithms: blinn, phong, constant or lambert. These shading algorithms</span><span class="WHIT">
<span class='line'>421</span> </span><span class="WHIT">		</span><span class="COMM">// are used in DCC tools which do not have adopted a shading language, therefore</span><span class="WHIT">
<span class='line'>422</span> </span><span class="WHIT">		</span><span class="COMM">// are using fixed functionality. Blinn shading algorithm is used by most DCC </span><span class="WHIT">
<span class='line'>423</span> </span><span class="WHIT">		</span><span class="COMM">// tools and therefore most common.</span><span class="WHIT">
<span class='line'>424</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">technique</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">profile_COMMON.getElementsByTagName</span><span class="PUNC">(</span><span class="STRN">"technique"</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>425</span> </span><span class="WHIT">		
<span class='line'>426</span> 		</span><span class="COMM">// get the texture</span><span class="WHIT">
<span class='line'>427</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">newparam</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">profile_COMMON.getElementsByTagName</span><span class="PUNC">(</span><span class="STRN">"newparam"</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>428</span> </span><span class="WHIT">		
<span class='line'>429</span> 		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">newparam</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>430</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>431</span> </span><span class="WHIT">			</span><span class="COMM">// go to the surface type</span><span class="WHIT">
<span class='line'>432</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">surface</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">newparam.getElementsByTagName</span><span class="PUNC">(</span><span class="STRN">"surface"</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>433</span> 
<span class='line'>434</span> </span><span class="WHIT">			</span><span class="COMM">// get the value between the &lt;init_from> tags</span><span class="WHIT">
<span class='line'>435</span> </span><span class="WHIT">			</span><span class="COMM">// the plane would have:</span><span class="WHIT">
<span class='line'>436</span> </span><span class="WHIT">			</span><span class="COMM">// &lt;init_from>file1&lt;/init_from></span><span class="WHIT">
<span class='line'>437</span> </span><span class="WHIT">			</span><span class="COMM">// it also has a format, but we ignore this for now.</span><span class="WHIT">
<span class='line'>438</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">init_from</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">surface.getElementsByTagName</span><span class="PUNC">(</span><span class="STRN">"init_from"</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>439</span> 
<span class='line'>440</span> </span><span class="WHIT">			</span><span class="COMM">// got the file id.</span><span class="WHIT">
<span class='line'>441</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">fileID</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">init_from.childNodes</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">nodeValue</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>442</span> 
<span class='line'>443</span> </span><span class="WHIT">			</span><span class="COMM">// file1 is an id of an image in the &lt;library_images> library</span><span class="WHIT">
<span class='line'>444</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">texture</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.findElementInLibrary</span><span class="PUNC">(</span><span class="NAME">xmlObject</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"library_images"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"image"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">fileID</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>445</span> 
<span class='line'>446</span> </span><span class="WHIT">			</span><span class="COMM">// finally, get the image name</span><span class="WHIT">
<span class='line'>447</span> </span><span class="WHIT">			</span><span class="COMM">//&lt;image id="file2" name="file2" depth="1"></span><span class="WHIT">
<span class='line'>448</span> </span><span class="WHIT">			</span><span class="COMM">//	&lt;init_from>./duckCM.tga&lt;/init_from></span><span class="WHIT">
<span class='line'>449</span> </span><span class="WHIT">			</span><span class="COMM">//&lt;/image></span><span class="WHIT">
<span class='line'>450</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">textureName</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">texture.getElementsByTagName</span><span class="PUNC">(</span><span class="STRN">"init_from"</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">childNodes</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">nodeValue</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>451</span> 
<span class='line'>452</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">resolvedTexture</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>453</span> 
<span class='line'>454</span> </span><span class="WHIT">			</span><span class="COMM">// if the texture is an abosolute path, use it.</span><span class="WHIT">
<span class='line'>455</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">c3dl.isPathAbsolute</span><span class="PUNC">(</span><span class="NAME">textureName</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>456</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>457</span> </span><span class="WHIT">				</span><span class="NAME">resolvedTexture</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">textureName</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>458</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>459</span> </span><span class="WHIT">			</span><span class="COMM">// otherwise, we need to place the path of dae file before the texture.</span><span class="WHIT">
<span class='line'>460</span> </span><span class="WHIT">			</span><span class="KEYW">else</span><span class="WHIT">
<span class='line'>461</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>462</span> </span><span class="WHIT">				</span><span class="NAME">resolvedTexture</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">c3dl.getPathWithoutFilename</span><span class="PUNC">(</span><span class="NAME">xmlObject.colladaPath</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">textureName</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>463</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>464</span> </span><span class="WHIT">			</span><span class="NAME">tempTexture</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">resolvedTexture</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>465</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>466</span> </span><span class="WHIT">		
<span class='line'>467</span> 		</span><span class="COMM">// get the shading algorithm used.</span><span class="WHIT">
<span class='line'>468</span> </span><span class="WHIT">		</span><span class="COMM">// as of right now, we aren't concerned with the algorithm itself, (we use our</span><span class="WHIT">
<span class='line'>469</span> </span><span class="WHIT">		</span><span class="COMM">// own custom shading algorithm) but what we want to extract are the properties</span><span class="WHIT">
<span class='line'>470</span> </span><span class="WHIT">		</span><span class="COMM">// of the shading method which include diffuse, ambient, specular, etc. components.</span><span class="WHIT">
<span class='line'>471</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">shadingAlgorithm</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.getChoice</span><span class="PUNC">(</span><span class="NAME">technique</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="STRN">"blinn"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"constant"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"phong"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"lambert"</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>472</span> 
<span class='line'>473</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">mat</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">c3dl.Material</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>474</span> </span><span class="WHIT">		</span><span class="COMM">//mat.texture = tempTexture;</span><span class="WHIT">
<span class='line'>475</span> </span><span class="WHIT">		</span><span class="NAME">mat.setName</span><span class="PUNC">(</span><span class="NAME">tempName</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>476</span> </span><span class="WHIT">		</span><span class="NAME">mat.setAmbient</span><span class="PUNC">(</span><span class="NAME">this.getColor</span><span class="PUNC">(</span><span class="NAME">shadingAlgorithm</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"ambient"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>477</span> </span><span class="WHIT">		</span><span class="NAME">mat.setDiffuse</span><span class="PUNC">(</span><span class="NAME">this.getColor</span><span class="PUNC">(</span><span class="NAME">shadingAlgorithm</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"diffuse"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>478</span> </span><span class="WHIT">		</span><span class="NAME">mat.setEmission</span><span class="PUNC">(</span><span class="NAME">this.getColor</span><span class="PUNC">(</span><span class="NAME">shadingAlgorithm</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"emission"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>479</span> </span><span class="WHIT">		</span><span class="NAME">mat.setSpecular</span><span class="PUNC">(</span><span class="NAME">this.getColor</span><span class="PUNC">(</span><span class="NAME">shadingAlgorithm</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"specular"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>480</span> </span><span class="WHIT">		</span><span class="NAME">mat.setShininess</span><span class="PUNC">(</span><span class="NAME">this.getColor</span><span class="PUNC">(</span><span class="NAME">shadingAlgorithm</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"shininess"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>481</span> </span><span class="WHIT">		
<span class='line'>482</span> 		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="NAME">mat</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">tempTexture</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>483</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>484</span> 
<span class='line'>485</span> </span><span class="WHIT">	</span><span class="COMM">/**
<span class='line'>486</span> 		@private
<span class='line'>487</span> 
<span class='line'>488</span> 		The root COLLADA can contain ZERO OR MANY library_geometries node.
<span class='line'>489</span> 		However in our case, since we are importing model data, should
<span class='line'>490</span> 		have at least one library_geometries.  If absent this will cause
<span class='line'>491</span> 		an error.
<span class='line'>492</span> 		
<span class='line'>493</span> 		The library geometries node contains 1 or Many &lt;geometry>
<span class='line'>494</span> 		nodes.
<span class='line'>495</span> 		If library_geometries describes a car,
<span class='line'>496</span> 		there may be several &lt;geometries> which described the chairs,
<span class='line'>497</span> 		seats, body, etc.
<span class='line'>498</span> 		
<span class='line'>499</span> 		@param {XMLDocument} xmlObject
<span class='line'>500</span> 		@param url
<span class='line'>501</span> 		@param instanceGeometryElement
<span class='line'>502</span> 	*/</span><span class="WHIT">
<span class='line'>503</span> </span><span class="WHIT">	</span><span class="NAME">this.instantiateGeometry</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">xmlObject</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">url</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">instanceGeometryElement</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>504</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>505</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">root</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">xmlObject.documentElement</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>506</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">libraryGeometries</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">root.getElementsByTagName</span><span class="PUNC">(</span><span class="STRN">"library_geometries"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>507</span> 
<span class='line'>508</span> </span><span class="WHIT">		</span><span class="COMM">// once not null, we can stop searching.</span><span class="WHIT">
<span class='line'>509</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">geoToCreate</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>510</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">geometry</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">c3dl.Geometry</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">		
<span class='line'>511</span> 
<span class='line'>512</span> 		</span><span class="COMM">// the url provided points to a geometry in a geometry library. We'll need to</span><span class="WHIT">
<span class='line'>513</span> </span><span class="WHIT">		</span><span class="COMM">// go through the libraries and find which library it is in.</span><span class="WHIT">
<span class='line'>514</span> 
<span class='line'>515</span> </span><span class="WHIT">		</span><span class="COMM">// TODO: add breakout when found</span><span class="WHIT">
<span class='line'>516</span> </span><span class="WHIT">		</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currLib</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currLib</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">libraryGeometries.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currLib</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>517</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>518</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">geometries</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">libraryGeometries</span><span class="PUNC">[</span><span class="NAME">currLib</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getElementsByTagName</span><span class="PUNC">(</span><span class="STRN">"geometry"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>519</span> </span><span class="WHIT">			</span><span class="COMM">// for each geometry</span><span class="WHIT">
<span class='line'>520</span> </span><span class="WHIT">			</span><span class="KEYW">for</span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currGeo</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currGeo</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">geometries.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currGeo</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>521</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>522</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">geometries</span><span class="PUNC">[</span><span class="NAME">currGeo</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="STRN">"id"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">url</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>523</span> </span><span class="WHIT">				</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>524</span> </span><span class="WHIT">					</span><span class="COMM">// found it</span><span class="WHIT">
<span class='line'>525</span> </span><span class="WHIT">					</span><span class="NAME">geoToCreate</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">geometries</span><span class="PUNC">[</span><span class="NAME">currGeo</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>526</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>527</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>528</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>529</span> 
<span class='line'>530</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">verticesArray</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>531</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">vertexStride</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>532</span> 
<span class='line'>533</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">normalsArray</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>534</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">normalsStride</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>535</span> 
<span class='line'>536</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">texCoordsArray</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>537</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">texCoordsStride</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>538</span> </span><span class="WHIT">		
<span class='line'>539</span> 		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">faces</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>540</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">rawFaces</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>541</span> 
<span class='line'>542</span> </span><span class="WHIT">		</span><span class="COMM">// the library geometry will have a &lt;mesh> which will have one or many &lt;triangles>.</span><span class="WHIT">
<span class='line'>543</span> </span><span class="WHIT">		</span><span class="COMM">// we have to go over each &lt;triangle> element and construct it.</span><span class="WHIT">
<span class='line'>544</span> 
<span class='line'>545</span> </span><span class="WHIT">		</span><span class="COMM">// &lt;geometry> contains all the data which describes a geometric object.</span><span class="WHIT">
<span class='line'>546</span> </span><span class="WHIT">		</span><span class="COMM">// &lt;geometry> contains &lt;mesh>, which in turn contains collation elements.</span><span class="WHIT">
<span class='line'>547</span> </span><span class="WHIT">		</span><span class="COMM">// these collation elements describe parts of the mesh differently either</span><span class="WHIT">
<span class='line'>548</span> </span><span class="WHIT">		</span><span class="COMM">// using polygons or lines.</span><span class="WHIT">
<span class='line'>549</span> </span><span class="WHIT">		</span><span class="COMM">//</span><span class="WHIT">
<span class='line'>550</span> </span><span class="WHIT">		</span><span class="COMM">// a geometry contains only one mesh node, so just get the first index.</span><span class="WHIT">
<span class='line'>551</span> </span><span class="WHIT">		</span><span class="COMM">// there are other kinds of meshes a geometry can have, but for now</span><span class="WHIT">
<span class='line'>552</span> </span><span class="WHIT">		</span><span class="COMM">// we aren't supporting them (convex_mesh, brep, spline, ...)</span><span class="WHIT">
<span class='line'>553</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">mesh</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">geoToCreate.getElementsByTagName</span><span class="PUNC">(</span><span class="STRN">"mesh"</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>554</span> 
<span class='line'>555</span> </span><span class="WHIT">		</span><span class="COMM">// we'll need to iterate over all the collation elements.</span><span class="WHIT">
<span class='line'>556</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">collations</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>557</span> </span><span class="WHIT">		
<span class='line'>558</span> 		</span><span class="COMM">// A mesh is composed of a set of collation elements.</span><span class="WHIT">
<span class='line'>559</span> </span><span class="WHIT">		</span><span class="COMM">// Types of collation elements are </span><span class="WHIT">
<span class='line'>560</span> </span><span class="WHIT">		</span><span class="COMM">// &lt;lines>, &lt;linestrips>,</span><span class="WHIT">
<span class='line'>561</span> </span><span class="WHIT">		</span><span class="COMM">// &lt;polygons>, &lt;polylist>,</span><span class="WHIT">
<span class='line'>562</span> </span><span class="WHIT">		</span><span class="COMM">// &lt;triangles>, &lt;tristrips>, &lt;trifans></span><span class="WHIT">
<span class='line'>563</span> </span><span class="WHIT">		</span><span class="COMM">//</span><span class="WHIT">
<span class='line'>564</span> </span><span class="WHIT">		</span><span class="COMM">// polygons can be a set of 3 or more vertices, therefore, we'll need to divide the polygons</span><span class="WHIT">
<span class='line'>565</span> </span><span class="WHIT">		</span><span class="COMM">// into triangles since GLES does not support quads or polygon rendering.</span><span class="WHIT">
<span class='line'>566</span> </span><span class="WHIT">		</span><span class="COMM">//</span><span class="WHIT">
<span class='line'>567</span> </span><span class="WHIT">		</span><span class="COMM">// The library does have means to render lines, but reading this primitive has not been added yet.</span><span class="WHIT">
<span class='line'>568</span> </span><span class="WHIT">		</span><span class="COMM">//</span><span class="WHIT">
<span class='line'>569</span> </span><span class="WHIT">		</span><span class="KEYW">for</span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">mesh.childNodes.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>570</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>571</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="WHIT">	</span><span class="NAME">mesh.childNodes</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">"triangles"</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> 
<span class='line'>572</span> 				</span><span class="NAME">mesh.childNodes</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">"polygons"</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT">
<span class='line'>573</span> </span><span class="WHIT">				</span><span class="NAME">mesh.childNodes</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">"polylist"</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>574</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>575</span> </span><span class="WHIT">				</span><span class="NAME">collations.push</span><span class="PUNC">(</span><span class="NAME">mesh.childNodes</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>576</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>577</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>578</span> </span><span class="WHIT">		
<span class='line'>579</span> 		</span><span class="COMM">// the collation elements have many primitives.</span><span class="WHIT">
<span class='line'>580</span> </span><span class="WHIT">		</span><span class="COMM">// &lt;p> element represents a primitive. </span><span class="WHIT">
<span class='line'>581</span> </span><span class="WHIT">		</span><span class="COMM">//</span><span class="WHIT">
<span class='line'>582</span> </span><span class="WHIT">		</span><span class="COMM">// currColl = current collation</span><span class="WHIT">
<span class='line'>583</span> </span><span class="WHIT">		</span><span class="KEYW">for</span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currColl</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currColl</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">collations.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currColl</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>584</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>585</span> </span><span class="WHIT">			</span><span class="COMM">// Depending on the type of collation element, the data will be layed out slighly differently.			</span><span class="WHIT">
<span class='line'>586</span> </span><span class="WHIT">			</span><span class="COMM">//</span><span class="WHIT">
<span class='line'>587</span> </span><span class="WHIT">			</span><span class="COMM">// &lt;triangles> and &lt;polylist> are similar in that they both only have one &lt;p> tag.</span><span class="WHIT">
<span class='line'>588</span> </span><span class="WHIT">			</span><span class="COMM">// polylist has an additional &lt;vcount> child element which has a list of integers</span><span class="WHIT">
<span class='line'>589</span> </span><span class="WHIT">			</span><span class="COMM">// which states the number of vertices per polygon (which can vary).</span><span class="WHIT">
<span class='line'>590</span> </span><span class="WHIT">			</span><span class="COMM">//</span><span class="WHIT">
<span class='line'>591</span> </span><span class="WHIT">			</span><span class="COMM">// triangles are always composed of 3 vertices so this element does not require &lt;vcount></span><span class="WHIT">
<span class='line'>592</span> </span><span class="WHIT">			</span><span class="COMM">//</span><span class="WHIT">
<span class='line'>593</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">collations</span><span class="PUNC">[</span><span class="NAME">currColl</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="STRN">"triangles"</span><span class="WHIT"> </span><span class="PUNC">||</span><span class="WHIT"> </span><span class="NAME">collations</span><span class="PUNC">[</span><span class="NAME">currColl</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="STRN">"polylist"</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>594</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">	
<span class='line'>595</span> 				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">p</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.getFirstChildByNodeName</span><span class="PUNC">(</span><span class="NAME">collations</span><span class="PUNC">[</span><span class="NAME">currColl</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="STRN">"p"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>596</span> </span><span class="WHIT">				</span><span class="NAME">rawFaces</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.mergeChildData</span><span class="PUNC">(</span><span class="NAME">p.childNodes</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">split</span><span class="PUNC">(</span><span class="STRN">" "</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">	
<span class='line'>597</span> 			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>598</span> 
<span class='line'>599</span> </span><span class="WHIT">			</span><span class="COMM">// &lt;polygon>s are broken up like this:</span><span class="WHIT">
<span class='line'>600</span> </span><span class="WHIT">			</span><span class="COMM">// &lt;p> 0 0 1 1 2 2 3 3 &lt;/p></span><span class="WHIT">
<span class='line'>601</span> </span><span class="WHIT">			</span><span class="COMM">// &lt;p> ... &lt;/p></span><span class="WHIT">
<span class='line'>602</span> </span><span class="WHIT">			</span><span class="COMM">// each &lt;p> element describes one polygon which can vary in length from others</span><span class="WHIT">
<span class='line'>603</span> </span><span class="WHIT">			</span><span class="COMM">//</span><span class="WHIT">
<span class='line'>604</span> </span><span class="WHIT">			</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">collations</span><span class="PUNC">[</span><span class="NAME">currColl</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">"polygons"</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>605</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>606</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">p_tags</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">collations</span><span class="PUNC">[</span><span class="NAME">currColl</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getElementsByTagName</span><span class="PUNC">(</span><span class="STRN">"p"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>607</span> </span><span class="WHIT">				</span><span class="NAME">rawFaces</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>608</span> </span><span class="WHIT">				</span><span class="KEYW">for</span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">p_tags.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>609</span> </span><span class="WHIT">				</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>610</span> </span><span class="WHIT">					</span><span class="COMM">// need to get rid of the spaces</span><span class="WHIT">
<span class='line'>611</span> </span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">p_line</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">p_tags</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">childNodes</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">nodeValue.split</span><span class="PUNC">(</span><span class="STRN">" "</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>612</span> </span><span class="WHIT">					</span><span class="KEYW">for</span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">j</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">j</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">p_line.length</span><span class="PUNC">;</span><span class="NAME">j</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>613</span> </span><span class="WHIT">					</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>614</span> </span><span class="WHIT">						</span><span class="NAME">rawFaces.push</span><span class="PUNC">(</span><span class="NAME">parseInt</span><span class="PUNC">(</span><span class="NAME">p_line</span><span class="PUNC">[</span><span class="NAME">j</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>615</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>616</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>617</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>618</span> </span><span class="WHIT">			</span><span class="COMM">// If this message is ever seen, that means I have to write the case for it.</span><span class="WHIT">
<span class='line'>619</span> </span><span class="WHIT">			</span><span class="KEYW">else</span><span class="WHIT">
<span class='line'>620</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>621</span> </span><span class="WHIT">				</span><span class="NAME">c3dl.debug.logError</span><span class="PUNC">(</span><span class="NAME">collations</span><span class="PUNC">[</span><span class="NAME">currColl</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="STRN">" collation element is not yet supported"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>622</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>623</span> 
<span class='line'>624</span> </span><span class="WHIT">			</span><span class="COMM">// At this point, we finished getting the faces for one collation element, the integers which will index</span><span class="WHIT">
<span class='line'>625</span> </span><span class="WHIT">			</span><span class="COMM">// into data steams. Now we move onto getting the input data streams.</span><span class="WHIT">
<span class='line'>626</span> 
<span class='line'>627</span> </span><span class="WHIT">			</span><span class="COMM">//</span><span class="WHIT">
<span class='line'>628</span> </span><span class="WHIT">			</span><span class="COMM">// get the inputs which contain the verts, normals, uvs.</span><span class="WHIT">
<span class='line'>629</span> </span><span class="WHIT">			</span><span class="COMM">//</span><span class="WHIT">
<span class='line'>630</span> </span><span class="WHIT">			</span><span class="COMM">// A collation element first contains the &lt;input> tags, then &lt;vcount> (in the case of</span><span class="WHIT">
<span class='line'>631</span> </span><span class="WHIT">			</span><span class="COMM">// &lt;polylist>) and then &lt;p> tags. The &lt;input> tags point to the raw data streams which </span><span class="WHIT">
<span class='line'>632</span> </span><span class="WHIT">			</span><span class="COMM">// </span><span class="WHIT">
<span class='line'>633</span> </span><span class="WHIT">			</span><span class="COMM">// The &lt;input> tags associate a semantic to a data stream. This explains how the raw data</span><span class="WHIT">
<span class='line'>634</span> </span><span class="WHIT">			</span><span class="COMM">// stream will be used for this particular context. &lt;input> has a source attribute which</span><span class="WHIT">
<span class='line'>635</span> </span><span class="WHIT">			</span><span class="COMM">// points to a source element which contains the raw data.</span><span class="WHIT">
<span class='line'>636</span> </span><span class="WHIT">			</span><span class="COMM">//</span><span class="WHIT">
<span class='line'>637</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">inputs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">collations</span><span class="PUNC">[</span><span class="NAME">currColl</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getElementsByTagName</span><span class="PUNC">(</span><span class="STRN">"input"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>638</span> </span><span class="WHIT">			
<span class='line'>639</span> 			</span><span class="NAME">collationElement</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">c3dl.PrimitiveSet</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>640</span> </span><span class="WHIT">			
<span class='line'>641</span> 			</span><span class="COMM">// The order of the &lt;input> tags can vary, so we can't rely on how they are arranged</span><span class="WHIT">
<span class='line'>642</span> </span><span class="WHIT">			</span><span class="COMM">// in most documents.</span><span class="WHIT">
<span class='line'>643</span> </span><span class="WHIT">			</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">inputs.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>644</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>645</span> </span><span class="WHIT">				</span><span class="COMM">/**************/</span><span class="WHIT">
<span class='line'>646</span> </span><span class="WHIT">				</span><span class="COMM">/*  VERTICES  */</span><span class="WHIT">
<span class='line'>647</span> </span><span class="WHIT">				</span><span class="COMM">/**************/</span><span class="WHIT">
<span class='line'>648</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">inputs</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="STRN">"semantic"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">"VERTEX"</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>649</span> </span><span class="WHIT">				</span><span class="PUNC">{</span><span class="WHIT">				
<span class='line'>650</span> 					</span><span class="NAME">this.vertexOffset</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">inputs</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="STRN">"offset"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>651</span> </span><span class="WHIT">					</span><span class="COMM">// need to remove the leading # from the value</span><span class="WHIT">
<span class='line'>652</span> </span><span class="WHIT">					</span><span class="NAME">this.vertexSource</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">inputs</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="STRN">"source"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">split</span><span class="PUNC">(</span><span class="STRN">'#'</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>653</span> 
<span class='line'>654</span> </span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">vertices</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">c3dl.ColladaLoader.getNodeWithAttribute</span><span class="PUNC">(</span><span class="NAME">xmlObject</span><span class="PUNC">,</span><span class="STRN">"vertices"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"id"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.vertexSource</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>655</span> 
<span class='line'>656</span> </span><span class="WHIT">					</span><span class="COMM">// get the child</span><span class="WHIT">
<span class='line'>657</span> </span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">input</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">vertices.getElementsByTagName</span><span class="PUNC">(</span><span class="STRN">"input"</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>658</span> 
<span class='line'>659</span> </span><span class="WHIT">					</span><span class="COMM">// get the &lt;input>s source				</span><span class="WHIT">
<span class='line'>660</span> </span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">posSource</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">input.getAttribute</span><span class="PUNC">(</span><span class="STRN">"source"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">split</span><span class="PUNC">(</span><span class="STRN">'#'</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>661</span> 
<span class='line'>662</span> </span><span class="WHIT">					</span><span class="COMM">// the raw data in a long list of floats, we have to group this so the face indices</span><span class="WHIT">
<span class='line'>663</span> </span><span class="WHIT">					</span><span class="COMM">// can index into it.</span><span class="WHIT">
<span class='line'>664</span> </span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">data</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.getData</span><span class="PUNC">(</span><span class="NAME">xmlObject</span><span class="PUNC">,</span><span class="STRN">"source"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"id"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">posSource</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>665</span> </span><span class="WHIT">					</span><span class="NAME">vertexStride</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parseInt</span><span class="PUNC">(</span><span class="NAME">data.stride</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>666</span> </span><span class="WHIT">					
<span class='line'>667</span> 					</span><span class="NAME">verticesArray</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.groupScalarsIntoArray</span><span class="PUNC">(</span><span class="NAME">data.values</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">3</span><span class="PUNC">,</span><span class="NAME">vertexStride</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>668</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>669</span> 
<span class='line'>670</span> </span><span class="WHIT">				</span><span class="COMM">/**************/</span><span class="WHIT">
<span class='line'>671</span> </span><span class="WHIT">				</span><span class="COMM">/*   NORMAL   */</span><span class="WHIT">
<span class='line'>672</span> </span><span class="WHIT">				</span><span class="COMM">/**************/</span><span class="WHIT">
<span class='line'>673</span> </span><span class="WHIT">				</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">inputs</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="STRN">"semantic"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">"NORMAL"</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>674</span> </span><span class="WHIT">				</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>675</span> </span><span class="WHIT">					</span><span class="NAME">this.normalOffset</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">inputs</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="STRN">"offset"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>676</span> </span><span class="WHIT">					</span><span class="COMM">// need to remove the leading # from the value</span><span class="WHIT">
<span class='line'>677</span> </span><span class="WHIT">					</span><span class="NAME">this.normalSource</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">inputs</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="STRN">"source"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">split</span><span class="PUNC">(</span><span class="STRN">'#'</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>678</span> </span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">data</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.getData</span><span class="PUNC">(</span><span class="NAME">xmlObject</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"source"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"id"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">this.normalSource</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>679</span> </span><span class="WHIT">					</span><span class="NAME">normalsStride</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parseInt</span><span class="PUNC">(</span><span class="NAME">data.stride</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>680</span> </span><span class="WHIT">					</span><span class="COMM">// length * stride instead of literal?</span><span class="WHIT">
<span class='line'>681</span> </span><span class="WHIT">					</span><span class="NAME">normalsArray</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.groupScalarsIntoArray</span><span class="PUNC">(</span><span class="NAME">data.values</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">3</span><span class="PUNC">,</span><span class="NAME">normalsStride</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>682</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>683</span> 
<span class='line'>684</span> </span><span class="WHIT">				</span><span class="COMM">/**************/</span><span class="WHIT">
<span class='line'>685</span> </span><span class="WHIT">				</span><span class="COMM">/*  TEXCOORD  */</span><span class="WHIT">
<span class='line'>686</span> </span><span class="WHIT">				</span><span class="COMM">/**************/</span><span class="WHIT">
<span class='line'>687</span> </span><span class="WHIT">				</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">inputs</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="STRN">"semantic"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">"TEXCOORD"</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>688</span> </span><span class="WHIT">				</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>689</span> </span><span class="WHIT">					</span><span class="NAME">this.texCoordOffset</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">inputs</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="STRN">"offset"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>690</span> </span><span class="WHIT">					</span><span class="COMM">// need to remove the leading # from the value</span><span class="WHIT">
<span class='line'>691</span> </span><span class="WHIT">					
<span class='line'>692</span> 					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">uvSource</span><span class="WHIT">  </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">inputs</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="STRN">"source"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">split</span><span class="PUNC">(</span><span class="STRN">'#'</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">			
<span class='line'>693</span> 					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">data</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.getData</span><span class="PUNC">(</span><span class="NAME">xmlObject</span><span class="PUNC">,</span><span class="STRN">"source"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"id"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">uvSource</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>694</span> </span><span class="WHIT">					</span><span class="NAME">texCoordsStride</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parseInt</span><span class="PUNC">(</span><span class="NAME">data.stride</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>695</span> </span><span class="WHIT">					
<span class='line'>696</span> 					</span><span class="COMM">// OpenGL ES seems to expect the bottom left corner of the</span><span class="WHIT">
<span class='line'>697</span> </span><span class="WHIT">					</span><span class="COMM">// texture in the top left, so we need to flip the texture coordinates</span><span class="WHIT">
<span class='line'>698</span> </span><span class="WHIT">					</span><span class="COMM">// start at 1, for V.</span><span class="WHIT">
<span class='line'>699</span> </span><span class="WHIT">					</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currUV</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currUV</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">data.values.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currUV</span><span class="PUNC">+</span><span class="PUNC">=</span><span class="NAME">texCoordsStride</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>700</span> </span><span class="WHIT">					</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>701</span> </span><span class="WHIT">						</span><span class="NAME">data.values</span><span class="PUNC">[</span><span class="NAME">currUV</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NAME">data.values</span><span class="PUNC">[</span><span class="NAME">currUV</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>702</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>703</span> 
<span class='line'>704</span> </span><span class="WHIT">					</span><span class="COMM">// we only want 2 values stored, but we may have to stride either 2 or</span><span class="WHIT">
<span class='line'>705</span> </span><span class="WHIT">					</span><span class="COMM">// 3 depending if a zero was added</span><span class="WHIT">
<span class='line'>706</span> </span><span class="WHIT">					</span><span class="COMM">// 1.0 1.0 0.0</span><span class="WHIT">
<span class='line'>707</span> </span><span class="WHIT">					</span><span class="COMM">//         ^ don't need this.</span><span class="WHIT">
<span class='line'>708</span> </span><span class="WHIT">					</span><span class="NAME">texCoordsArray</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.groupScalarsIntoArray</span><span class="PUNC">(</span><span class="NAME">data.values</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NUMB">2</span><span class="PUNC">,</span><span class="NAME">texCoordsStride</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>709</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>710</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>711</span> </span><span class="WHIT">			
<span class='line'>712</span> 			
<span class='line'>713</span> 			</span><span class="COMM">// We now have the faces for a collation element and its input data streams,</span><span class="WHIT">
<span class='line'>714</span> </span><span class="WHIT">			</span><span class="COMM">// however if the collation element is a &lt;polylist> or &lt;polygon>, we'll need to</span><span class="WHIT">
<span class='line'>715</span> </span><span class="WHIT">			</span><span class="COMM">// re-arrange some of the faces since OpenGLES does not support quads.</span><span class="WHIT">
<span class='line'>716</span> </span><span class="WHIT">			</span><span class="COMM">//  The next two conditionals handle these two cases.</span><span class="WHIT">
<span class='line'>717</span> </span><span class="WHIT">			
<span class='line'>718</span> 			
<span class='line'>719</span> 			
<span class='line'>720</span> 			</span><span class="COMM">// &lt;polylist> contains a list of polygons, each which can contains a different number </span><span class="WHIT">
<span class='line'>721</span> </span><span class="WHIT">			</span><span class="COMM">// of vertices (one poly has 3 another has 5).  Since we can't render polygons or even</span><span class="WHIT">
<span class='line'>722</span> </span><span class="WHIT">			</span><span class="COMM">// quads in GLES, the polygons need to be broken down into triangles. Note, it is assumed</span><span class="WHIT">
<span class='line'>723</span> </span><span class="WHIT">			</span><span class="COMM">// only simple convex polygons are used. (no intersections are present and no polygons are</span><span class="WHIT">
<span class='line'>724</span> </span><span class="WHIT">			</span><span class="COMM">// concave). If there are intersections or the polygons are concave, they will be represented</span><span class="WHIT">
<span class='line'>725</span> </span><span class="WHIT">			</span><span class="COMM">// incorrectly.</span><span class="WHIT">
<span class='line'>726</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">collations</span><span class="PUNC">[</span><span class="NAME">currColl</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">"polylist"</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>727</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>728</span> </span><span class="WHIT">				</span><span class="NAME">rawFaces</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.splitPolylist</span><span class="PUNC">(</span><span class="NAME">collations</span><span class="PUNC">[</span><span class="NAME">currColl</span><span class="PUNC">]</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">inputs.length</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">rawFaces</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>729</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>730</span> </span><span class="WHIT">						
<span class='line'>731</span> 			</span><span class="COMM">// before we group the individual values in the faces array into</span><span class="WHIT">
<span class='line'>732</span> </span><span class="WHIT">			</span><span class="COMM">// arrays so we can easily address values in the arrays for vertices,</span><span class="WHIT">
<span class='line'>733</span> </span><span class="WHIT">			</span><span class="COMM">// textures, etc, we have to convert the quads into triangles since</span><span class="WHIT">
<span class='line'>734</span> </span><span class="WHIT">			</span><span class="COMM">// OpenGLES does not support the QUADS primitive mode.</span><span class="WHIT">
<span class='line'>735</span> </span><span class="WHIT">			</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">collations</span><span class="PUNC">[</span><span class="NAME">currColl</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">"polygons"</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>736</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>737</span> </span><span class="WHIT">				</span><span class="COMM">// example looks like this:</span><span class="WHIT">
<span class='line'>738</span> </span><span class="WHIT">				</span><span class="COMM">// 0,0,1,1,2,2,3,3,4,4,....</span><span class="WHIT">
<span class='line'>739</span> </span><span class="WHIT">				</span><span class="COMM">// here is a quad and collada states its winding</span><span class="WHIT">
<span class='line'>740</span> </span><span class="WHIT">				</span><span class="COMM">// order is counter clockwise, so our goal</span><span class="WHIT">
<span class='line'>741</span> </span><span class="WHIT">				</span><span class="COMM">// to convert it to:</span><span class="WHIT">
<span class='line'>742</span> </span><span class="WHIT">				</span><span class="COMM">// 0,0, 1,1, 3,3 3,3 1,1 2,2</span><span class="WHIT">
<span class='line'>743</span> </span><span class="WHIT">				</span><span class="COMM">// which is 2 triangles.</span><span class="WHIT">
<span class='line'>744</span> </span><span class="WHIT">				
<span class='line'>745</span> 				</span><span class="COMM">// first thing is to seperate the individual numbers into 'parts'</span><span class="WHIT">
<span class='line'>746</span> </span><span class="WHIT">				</span><span class="COMM">// 0,0 is one part,  2,2 is another part.  If there are more</span><span class="WHIT">
<span class='line'>747</span> </span><span class="WHIT">				</span><span class="COMM">// inputs, we have to account for that and our parts will be</span><span class="WHIT">
<span class='line'>748</span> </span><span class="WHIT">				</span><span class="COMM">// larger</span><span class="WHIT">
<span class='line'>749</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">partSize</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">inputs.length</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>750</span> </span><span class="WHIT">				
<span class='line'>751</span> 				</span><span class="COMM">// make a new list which uses triangles and which will overrite the quads list.</span><span class="WHIT">
<span class='line'>752</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">trianglesList</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"> 
<span class='line'>753</span> 				
<span class='line'>754</span> 				</span><span class="COMM">// knowing the partSize, we can use it as a stride to create a new face list</span><span class="WHIT">
<span class='line'>755</span> </span><span class="WHIT">				
<span class='line'>756</span> 				</span><span class="COMM">// count is an attribute of polygons which lists how many primitives the</span><span class="WHIT">
<span class='line'>757</span> </span><span class="WHIT">				</span><span class="COMM">// polygon has. we can use this data to find out how many times we have to</span><span class="WHIT">
<span class='line'>758</span> </span><span class="WHIT">				</span><span class="COMM">// change the parts.</span><span class="WHIT">
<span class='line'>759</span> </span><span class="WHIT">				</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currPrim</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currPrim</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">collations</span><span class="PUNC">[</span><span class="NAME">currColl</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="STRN">"count"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currPrim</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>760</span> </span><span class="WHIT">				</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>761</span> </span><span class="WHIT">					</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">partsArray</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>762</span> </span><span class="WHIT">					
<span class='line'>763</span> 					</span><span class="COMM">// make an array of array so we can easily index parts</span><span class="WHIT">
<span class='line'>764</span> </span><span class="WHIT">					</span><span class="COMM">// use four since a polygon primitive is defined as having 4 points</span><span class="WHIT">
<span class='line'>765</span> </span><span class="WHIT">					</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currPart</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currPart</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NUMB">4</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currPart</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>766</span> </span><span class="WHIT">					</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>767</span> </span><span class="WHIT">						</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">part</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>768</span> </span><span class="WHIT">						</span><span class="KEYW">for</span><span class="PUNC">(</span><span class="NAME">currScalar</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currScalar</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">inputs.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currScalar</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>769</span> </span><span class="WHIT">						</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>770</span> </span><span class="WHIT">							</span><span class="NAME">part.push</span><span class="PUNC">(</span><span class="NAME">rawFaces</span><span class="PUNC">[</span><span class="PUNC">(</span><span class="NAME">currPrim</span><span class="WHIT"> </span><span class="PUNC">*</span><span class="WHIT"> </span><span class="NAME">inputs.length</span><span class="WHIT"> </span><span class="PUNC">*</span><span class="WHIT"> </span><span class="NUMB">4</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">currPart</span><span class="WHIT"> </span><span class="PUNC">*</span><span class="WHIT"> </span><span class="NAME">partSize</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">currScalar</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>771</span> </span><span class="WHIT">						</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>772</span> </span><span class="WHIT">						</span><span class="NAME">partsArray.push</span><span class="PUNC">(</span><span class="NAME">part</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>773</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>774</span> 
<span class='line'>775</span> </span><span class="WHIT">					</span><span class="COMM">// need to push on the RAW values, don't push on arrays.</span><span class="WHIT">
<span class='line'>776</span> </span><span class="WHIT">					</span><span class="COMM">// TODO: write a function for this.</span><span class="WHIT">
<span class='line'>777</span> </span><span class="WHIT">					</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">s</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">s</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">partsArray</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">s</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="NAME">trianglesList.push</span><span class="PUNC">(</span><span class="NAME">partsArray</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">s</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>778</span> </span><span class="WHIT">					</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">s</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">s</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">partsArray</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">s</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="NAME">trianglesList.push</span><span class="PUNC">(</span><span class="NAME">partsArray</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">s</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>779</span> </span><span class="WHIT">					</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">s</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">s</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">partsArray</span><span class="PUNC">[</span><span class="NUMB">3</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">s</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="NAME">trianglesList.push</span><span class="PUNC">(</span><span class="NAME">partsArray</span><span class="PUNC">[</span><span class="NUMB">3</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">s</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>780</span> </span><span class="WHIT">					</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">s</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">s</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">partsArray</span><span class="PUNC">[</span><span class="NUMB">3</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">s</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="NAME">trianglesList.push</span><span class="PUNC">(</span><span class="NAME">partsArray</span><span class="PUNC">[</span><span class="NUMB">3</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">s</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>781</span> </span><span class="WHIT">					</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">s</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">s</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">partsArray</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">s</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="NAME">trianglesList.push</span><span class="PUNC">(</span><span class="NAME">partsArray</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">s</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>782</span> </span><span class="WHIT">					</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">s</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">s</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">partsArray</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">s</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="PUNC">{</span><span class="NAME">trianglesList.push</span><span class="PUNC">(</span><span class="NAME">partsArray</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">s</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>783</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>784</span> </span><span class="WHIT">				</span><span class="COMM">// now we can overrite what rawFaces had in it</span><span class="WHIT">
<span class='line'>785</span> </span><span class="WHIT">				</span><span class="NAME">rawFaces</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">trianglesList</span><span class="PUNC">;</span><span class="WHIT">	
<span class='line'>786</span> 			</span><span class="PUNC">}</span><span class="COMM">// if polygons</span><span class="WHIT">
<span class='line'>787</span> </span><span class="WHIT">			
<span class='line'>788</span> 			</span><span class="COMM">// we don't need a case for triangles since</span><span class="WHIT">
<span class='line'>789</span> </span><span class="WHIT">			
<span class='line'>790</span> 			</span><span class="COMM">// now that we know how many inputs there were, we can group the faces.</span><span class="WHIT">
<span class='line'>791</span> </span><span class="WHIT">			</span><span class="NAME">faces</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.groupScalarsIntoArray</span><span class="PUNC">(</span><span class="NAME">rawFaces</span><span class="PUNC">,</span><span class="NAME">inputs.length</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">inputs.length</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>792</span> </span><span class="WHIT">		
<span class='line'>793</span> 			</span><span class="COMM">// each primitive collation element can have a material name. this name matches to the</span><span class="WHIT">
<span class='line'>794</span> </span><span class="WHIT">			</span><span class="COMM">// &lt;instance_material>'s symbol attribute value.					</span><span class="WHIT">
<span class='line'>795</span> </span><span class="WHIT">			</span><span class="NAME">collationElement.tempMaterial</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">collations</span><span class="PUNC">[</span><span class="NAME">currColl</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="STRN">"material"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>796</span> </span><span class="WHIT">			</span><span class="NAME">collationElement.init</span><span class="PUNC">(</span><span class="WHIT">	</span><span class="NAME">this.expandFaces</span><span class="PUNC">(</span><span class="NAME">faces</span><span class="PUNC">,</span><span class="NAME">verticesArray</span><span class="PUNC">,</span><span class="NAME">this.vertexOffset</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">vertexStride</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>797</span> </span><span class="WHIT">									</span><span class="NAME">this.expandFaces</span><span class="PUNC">(</span><span class="NAME">faces</span><span class="PUNC">,</span><span class="NAME">normalsArray</span><span class="PUNC">,</span><span class="NAME">this.normalOffset</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">normalsStride</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'>798</span> </span><span class="WHIT">									</span><span class="NAME">this.expandFaces</span><span class="PUNC">(</span><span class="NAME">faces</span><span class="PUNC">,</span><span class="NAME">texCoordsArray</span><span class="PUNC">,</span><span class="NAME">this.texCoordOffset</span><span class="PUNC">,</span><span class="NUMB">2</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>799</span> </span><span class="WHIT">			
<span class='line'>800</span> 			</span><span class="NAME">geometry.addPrimitiveSet</span><span class="PUNC">(</span><span class="NAME">collationElement</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>801</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="COMM">// end iterating over collations</span><span class="WHIT">
<span class='line'>802</span> </span><span class="WHIT">		
<span class='line'>803</span> 
<span class='line'>804</span> 
<span class='line'>805</span> 		</span><span class="COMM">// get the texture for the geometry</span><span class="WHIT">
<span class='line'>806</span> </span><span class="WHIT">		</span><span class="COMM">// go back to the instance_geometry</span><span class="WHIT">
<span class='line'>807</span> </span><span class="WHIT">		
<span class='line'>808</span> 		</span><span class="COMM">// &lt;instance_geometry> has either 0 or 1 &lt;bind_material>, so just get the first if it exsits.</span><span class="WHIT">
<span class='line'>809</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">bind_material</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">instanceGeometryElement.getElementsByTagName</span><span class="PUNC">(</span><span class="STRN">"bind_material"</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>810</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">bind_material</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>811</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>812</span> </span><span class="WHIT">			</span><span class="COMM">// &lt;bind_material> has exactly 1 &lt;technique_common>, so only get the first.</span><span class="WHIT">
<span class='line'>813</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">technique_common</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">bind_material.getElementsByTagName</span><span class="PUNC">(</span><span class="STRN">"technique_common"</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>814</span> 
<span class='line'>815</span> </span><span class="WHIT">			</span><span class="COMM">// technique_common within instance geometry may have many materials.</span><span class="WHIT">
<span class='line'>816</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">instance_materials</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">technique_common.getElementsByTagName</span><span class="PUNC">(</span><span class="STRN">"instance_material"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>817</span> 
<span class='line'>818</span> </span><span class="WHIT">			</span><span class="COMM">// iterate over all the &lt;instance_material>'s &lt;technique_common> has.</span><span class="WHIT">
<span class='line'>819</span> </span><span class="WHIT">			</span><span class="KEYW">for</span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">im</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="NAME">im</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">instance_materials.length</span><span class="PUNC">;</span><span class="NAME">im</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>820</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>821</span> </span><span class="WHIT">				</span><span class="COMM">// target is the target material to instantiate</span><span class="WHIT">
<span class='line'>822</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">target</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">instance_materials</span><span class="PUNC">[</span><span class="NAME">im</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="STRN">"target"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">split</span><span class="PUNC">(</span><span class="STRN">'#'</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>823</span> </span><span class="WHIT">				
<span class='line'>824</span> 				</span><span class="COMM">// symbol links to the primitive collation's material attribute.</span><span class="WHIT">
<span class='line'>825</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">symbol</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">instance_materials</span><span class="PUNC">[</span><span class="NAME">im</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="STRN">"symbol"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>826</span> </span><span class="WHIT">						
<span class='line'>827</span> 				</span><span class="COMM">// we now have the material ID which we can look up in the library materials.</span><span class="WHIT">
<span class='line'>828</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">material</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.findElementInLibrary</span><span class="PUNC">(</span><span class="NAME">xmlObject</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"library_materials"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"material"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">target</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>829</span> 
<span class='line'>830</span> </span><span class="WHIT">				</span><span class="COMM">//</span><span class="WHIT">
<span class='line'>831</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">matAndTex</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.instantiateMaterial</span><span class="PUNC">(</span><span class="NAME">xmlObject</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">target</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>832</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">instanceMaterial</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">matAndTex</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>833</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">tex</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">matAndTex</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>834</span> </span><span class="WHIT">				
<span class='line'>835</span> 				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">GeoCollations</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">geometry.getPrimitiveSets</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>836</span> </span><span class="WHIT">				
<span class='line'>837</span> 				</span><span class="COMM">// The material was instantiated and now we have to iterate over the collations</span><span class="WHIT">
<span class='line'>838</span> </span><span class="WHIT">				</span><span class="COMM">// and find the collation which has a material which matches the material name.</span><span class="WHIT">
<span class='line'>839</span> </span><span class="WHIT">				</span><span class="KEYW">for</span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">ic</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">ic</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">GeoCollations.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">ic</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>840</span> </span><span class="WHIT">				</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>841</span> </span><span class="WHIT">					</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">GeoCollations</span><span class="PUNC">[</span><span class="NAME">ic</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">tempMaterial</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">symbol</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>842</span> </span><span class="WHIT">					</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>843</span> </span><span class="WHIT">						</span><span class="NAME">GeoCollations</span><span class="PUNC">[</span><span class="NAME">ic</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">setMaterial</span><span class="PUNC">(</span><span class="NAME">instanceMaterial</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>844</span> </span><span class="WHIT">						</span><span class="NAME">GeoCollations</span><span class="PUNC">[</span><span class="NAME">ic</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">setTexture</span><span class="PUNC">(</span><span class="NAME">tex</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>845</span> </span><span class="WHIT">					</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>846</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>847</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="COMM">// instance_materials loop</span><span class="WHIT">
<span class='line'>848</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="COMM">// bind_material conditional</span><span class="WHIT">
<span class='line'>849</span> </span><span class="WHIT">		
<span class='line'>850</span> 		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">geometry</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>851</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>852</span> 
<span class='line'>853</span> </span><span class="WHIT">	</span><span class="COMM">/**
<span class='line'>854</span> 		@private
<span class='line'>855</span> 		@param {XMLDocument} xmlObject
<span class='line'>856</span> 		@param {String} url
<span class='line'>857</span> 
<span class='line'>858</span> 		@returns {c3dl.SceneNode}
<span class='line'>859</span> 	*/</span><span class="WHIT">
<span class='line'>860</span> </span><span class="WHIT">	</span><span class="NAME">this.instantiateNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">xmlObject</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">url</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>861</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>862</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">root</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">xmlObject.documentElement</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>863</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">libraryNodes</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">root.getElementsByTagName</span><span class="PUNC">(</span><span class="STRN">"library_nodes"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>864</span> </span><span class="WHIT">		
<span class='line'>865</span> 		</span><span class="COMM">// domNode</span><span class="WHIT">
<span class='line'>866</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">nodeToCreate</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>867</span> </span><span class="WHIT">			
<span class='line'>868</span> 		</span><span class="COMM">// &lt;collada> may have many &lt;library_node>. We'll need to go through each to find</span><span class="WHIT">
<span class='line'>869</span> </span><span class="WHIT">		</span><span class="COMM">// the node with the name we are looking for.</span><span class="WHIT">
<span class='line'>870</span> </span><span class="WHIT">		</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currLib</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currLib</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">libraryNodes.length</span><span class="WHIT"> </span><span class="COMM">/*&& nodeToCreate == null*/</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currLib</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>871</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>872</span> </span><span class="WHIT">			</span><span class="COMM">// get all the nodes in this library.</span><span class="WHIT">
<span class='line'>873</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">nodes</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">libraryNodes</span><span class="PUNC">[</span><span class="NAME">currLib</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getElementsByTagName</span><span class="PUNC">(</span><span class="STRN">"node"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>874</span> 
<span class='line'>875</span> </span><span class="WHIT">			</span><span class="COMM">// find the node in the list.</span><span class="WHIT">
<span class='line'>876</span> </span><span class="WHIT">			</span><span class="KEYW">for</span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currNode</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">nodes.length</span><span class="WHIT"> </span><span class="COMM">/*&& nodeToCreate == null*/</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currNode</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>877</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>878</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">nodes</span><span class="PUNC">[</span><span class="NAME">currNode</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="STRN">"id"</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">url</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>879</span> </span><span class="WHIT">				</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>880</span> </span><span class="WHIT">					</span><span class="COMM">// found it</span><span class="WHIT">
<span class='line'>881</span> </span><span class="WHIT">					</span><span class="NAME">nodeToCreate</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nodes</span><span class="PUNC">[</span><span class="NAME">currNode</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>882</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>883</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>884</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>885</span> 
<span class='line'>886</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">inode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">c3dl.SceneNode</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>887</span> </span><span class="WHIT">		</span><span class="NAME">inode.setName</span><span class="PUNC">(</span><span class="NAME">nodeToCreate.getAttribute</span><span class="PUNC">(</span><span class="STRN">"name"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">		
<span class='line'>888</span> 		
<span class='line'>889</span> 		</span><span class="NAME">this.parseNodeRecursive</span><span class="PUNC">(</span><span class="NAME">xmlObject</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">nodeToCreate</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">inode</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>890</span> 
<span class='line'>891</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">inode</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>892</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">	
<span class='line'>893</span> 
<span class='line'>894</span> 	</span><span class="COMM">/**
<span class='line'>895</span> 		@private
<span class='line'>896</span> 		This function takes a list of scalar values and 
<span class='line'>897</span> 		groups them into elements inside an array.  This 
<span class='line'>898</span> 		must be done since in the DAE file, the values are
<span class='line'>899</span> 		stored one after another in a linear format. Since
<span class='line'>900</span> 		the triangles/faces use indices to access these scalars,
<span class='line'>901</span> 		we have to group them together so indexing will work 
<span class='line'>902</span> 		properly.
<span class='line'>903</span> 		
<span class='line'>904</span> 		@param {Array} rawScalarValues
<span class='line'>905</span> 		@param {int} numComponentsPerElement
<span class='line'>906</span> 		@param {int} stride
<span class='line'>907</span> 		
<span class='line'>908</span> 		@returns {Array}
<span class='line'>909</span> 	*/</span><span class="WHIT">
<span class='line'>910</span> </span><span class="WHIT">	</span><span class="NAME">this.groupScalarsIntoArray</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">rawScalarValues</span><span class="PUNC">,</span><span class="NAME">numComponentsPerElement</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">stride</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>911</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">	
<span class='line'>912</span> 		</span><span class="COMM">// start off with an empty list</span><span class="WHIT">
<span class='line'>913</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">listOfArrays</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>914</span> </span><span class="WHIT">		
<span class='line'>915</span> 		</span><span class="COMM">//</span><span class="WHIT">
<span class='line'>916</span> </span><span class="WHIT">		</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">rawScalarValues.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">stride</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>917</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>918</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">element</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>919</span> </span><span class="WHIT">			
<span class='line'>920</span> 			</span><span class="COMM">//</span><span class="WHIT">
<span class='line'>921</span> </span><span class="WHIT">			</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">j</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">j</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">+</span><span class="NAME">numComponentsPerElement</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">j</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>922</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>923</span> </span><span class="WHIT">				</span><span class="NAME">element.push</span><span class="PUNC">(</span><span class="NAME">rawScalarValues</span><span class="PUNC">[</span><span class="NAME">j</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>924</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>925</span> 
<span class='line'>926</span> </span><span class="WHIT">			</span><span class="NAME">listOfArrays.push</span><span class="PUNC">(</span><span class="NAME">element</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>927</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>928</span> 
<span class='line'>929</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">listOfArrays</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>930</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>931</span> </span><span class="WHIT">	
<span class='line'>932</span> 
<span class='line'>933</span> 	</span><span class="COMM">/**
<span class='line'>934</span> 		@private
<span class='line'>935</span> 
<span class='line'>936</span> 		@param {} collation
<span class='line'>937</span> 		@param {int} numInputs
<span class='line'>938</span> 		@param {Array} rawFaces
<span class='line'>939</span> 	*/</span><span class="WHIT">
<span class='line'>940</span> </span><span class="WHIT">	</span><span class="NAME">this.splitPolylist</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">collation</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">numInputs</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">rawFaces</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>941</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>942</span> </span><span class="WHIT">		</span><span class="COMM">// rawFaces = this.splitPolylist(collations[currColl], inputs.length);</span><span class="WHIT">
<span class='line'>943</span> </span><span class="WHIT">	
<span class='line'>944</span> 		</span><span class="COMM">// &lt;vcount> has the count of vertices for each polygon.</span><span class="WHIT">
<span class='line'>945</span> </span><span class="WHIT">		</span><span class="COMM">// &lt;vcount> 4 4 4 3 4 5 3 4 .. &lt;/vcount></span><span class="WHIT">
<span class='line'>946</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">vcountNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.getFirstChildByNodeName</span><span class="PUNC">(</span><span class="NAME">collation</span><span class="PUNC">,</span><span class="STRN">"vcount"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>947</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">vcountList</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.mergeChildData</span><span class="PUNC">(</span><span class="NAME">vcountNode.childNodes</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">split</span><span class="PUNC">(</span><span class="STRN">" "</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>948</span> 
<span class='line'>949</span> </span><span class="WHIT">		</span><span class="COMM">// this counter keeps track of where we are in the vcount list</span><span class="WHIT">
<span class='line'>950</span> </span><span class="WHIT">		</span><span class="COMM">// &lt;vcount>4 4 3 4 4 4 5 ... 4 4 3 4&lt;/vcount></span><span class="WHIT">
<span class='line'>951</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">vcountIndex</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>952</span> </span><span class="WHIT">		
<span class='line'>953</span> 		</span><span class="COMM">// </span><span class="WHIT">
<span class='line'>954</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">primOffset</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>955</span> </span><span class="WHIT">	
<span class='line'>956</span> 		</span><span class="COMM">// since we can only support triangles, we have to make a triangle list</span><span class="WHIT">
<span class='line'>957</span> </span><span class="WHIT">		</span><span class="COMM">// and convert any quads to triangles.</span><span class="WHIT">
<span class='line'>958</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">trianglesList</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>959</span> </span><span class="WHIT">		
<span class='line'>960</span> 		</span><span class="COMM">//</span><span class="WHIT">
<span class='line'>961</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">partSize</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">numInputs</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>962</span> </span><span class="WHIT">		
<span class='line'>963</span> 		</span><span class="COMM">// iterate from the 0 to vcount, this is the number of primitives</span><span class="WHIT">
<span class='line'>964</span> </span><span class="WHIT">		</span><span class="COMM">// there are in this mesh.  Primitives in a polylist may have</span><span class="WHIT">
<span class='line'>965</span> </span><span class="WHIT">		</span><span class="COMM">// more than 4 vertices, we will solve this by making the </span><span class="WHIT">
<span class='line'>966</span> </span><span class="WHIT">		</span><span class="COMM">// triangle fans.</span><span class="WHIT">
<span class='line'>967</span> </span><span class="WHIT">		</span><span class="COMM">// Vertices, according to the spec, will be counter clockwise.  Because</span><span class="WHIT">
<span class='line'>968</span> </span><span class="WHIT">		</span><span class="COMM">// of this, we should be able to make fans without problems.</span><span class="WHIT">
<span class='line'>969</span> </span><span class="WHIT">		</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currPrim</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currPrim</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">collation.getAttribute</span><span class="PUNC">(</span><span class="STRN">"count"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currPrim</span><span class="PUNC">++</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">vcountIndex</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>970</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>971</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">partsArray</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>972</span> </span><span class="WHIT">			
<span class='line'>973</span> 			</span><span class="COMM">// the current number in the vcount list may have different values depending, may have 3, 4 or more</span><span class="WHIT">
<span class='line'>974</span> </span><span class="WHIT">			</span><span class="COMM">// so we have to iterate for the amount of values in the primitive.</span><span class="WHIT">
<span class='line'>975</span> </span><span class="WHIT">			</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currPart</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currPart</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">vcountList</span><span class="PUNC">[</span><span class="NAME">vcountIndex</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currPart</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>976</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>977</span> </span><span class="WHIT">				</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">part</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>978</span> 
<span class='line'>979</span> </span><span class="WHIT">				</span><span class="KEYW">for</span><span class="PUNC">(</span><span class="NAME">currScalar</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currScalar</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">numInputs</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currScalar</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>980</span> </span><span class="WHIT">				</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>981</span> </span><span class="WHIT">					</span><span class="COMM">// first part (primOffset * inputs.length) indexes into the primitive</span><span class="WHIT">
<span class='line'>982</span> </span><span class="WHIT">					</span><span class="COMM">// part.  Second part will index into the specific part we want.</span><span class="WHIT">
<span class='line'>983</span> </span><span class="WHIT">					</span><span class="NAME">part.push</span><span class="PUNC">(</span><span class="NAME">rawFaces</span><span class="PUNC">[</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">primOffset</span><span class="WHIT"> </span><span class="PUNC">*</span><span class="WHIT"> </span><span class="NAME">numInputs</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">currPart</span><span class="WHIT"> </span><span class="PUNC">*</span><span class="WHIT"> </span><span class="NAME">numInputs</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NAME">currScalar</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>984</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>985</span> </span><span class="WHIT">				</span><span class="NAME">partsArray.push</span><span class="PUNC">(</span><span class="NAME">part</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>986</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>987</span> </span><span class="WHIT">			</span><span class="COMM">// set the new value for the primitive offset</span><span class="WHIT">
<span class='line'>988</span> </span><span class="WHIT">			</span><span class="COMM">// since the number of vertices vary in a list of primitives,</span><span class="WHIT">
<span class='line'>989</span> </span><span class="WHIT">			</span><span class="COMM">// we just keep track how many we have to skip here.</span><span class="WHIT">
<span class='line'>990</span> </span><span class="WHIT">			</span><span class="COMM">// 4 3 4 3 3</span><span class="WHIT">
<span class='line'>991</span> </span><span class="WHIT">			</span><span class="COMM">// we can't just calculate how many values we have to skip, we acutally</span><span class="WHIT">
<span class='line'>992</span> </span><span class="WHIT">			</span><span class="COMM">// have to keep the total count.</span><span class="WHIT">
<span class='line'>993</span> </span><span class="WHIT">			</span><span class="NAME">primOffset</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parseInt</span><span class="PUNC">(</span><span class="NAME">vcountList</span><span class="PUNC">[</span><span class="NAME">vcountIndex</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>994</span> 
<span class='line'>995</span> </span><span class="WHIT">			</span><span class="COMM">// the way we will create a triangle fan is by creating a pivot</span><span class="WHIT">
<span class='line'>996</span> </span><span class="WHIT">			</span><span class="COMM">// vertex and keep track of the last vertex added.</span><span class="WHIT">
<span class='line'>997</span> </span><span class="WHIT">			</span><span class="COMM">// everytime a new vertex is added we will create a triangle from</span><span class="WHIT">
<span class='line'>998</span> </span><span class="WHIT">			</span><span class="COMM">// the pivot, the last vertex and the new one.</span><span class="WHIT">
<span class='line'>999</span> 
<span class='line'>1000</span> </span><span class="WHIT">			</span><span class="COMM">// start this as index 1. the first time this main loop runs, </span><span class="WHIT">
<span class='line'>1001</span> </span><span class="WHIT">			</span><span class="COMM">// last will actually be the middle vertex, from then on, it </span><span class="WHIT">
<span class='line'>1002</span> </span><span class="WHIT">			</span><span class="COMM">// will act as the last one added since before the iteration ends</span><span class="WHIT">
<span class='line'>1003</span> </span><span class="WHIT">			</span><span class="COMM">// we set last to be the fanIndex</span><span class="WHIT">
<span class='line'>1004</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">last</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1005</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">firstTriangle</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1006</span> </span><span class="WHIT">			</span><span class="COMM">// create a triangle fan</span><span class="WHIT">
<span class='line'>1007</span> </span><span class="WHIT">			</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">fanIndex</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">fanIndex</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">vcountList</span><span class="PUNC">[</span><span class="NAME">vcountIndex</span><span class="PUNC">]</span><span class="PUNC">-</span><span class="NUMB">1</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1008</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1009</span> </span><span class="WHIT">				</span><span class="COMM">// s iterator is for scalar, we are dealing with single values.</span><span class="WHIT">
<span class='line'>1010</span> </span><span class="WHIT">				</span><span class="COMM">// push on the first </span><span class="WHIT">
<span class='line'>1011</span> </span><span class="WHIT">				</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">s</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">s</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">partsArray</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">s</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1012</span> </span><span class="WHIT">				</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1013</span> </span><span class="WHIT">					</span><span class="COMM">// first</span><span class="WHIT">
<span class='line'>1014</span> </span><span class="WHIT">					</span><span class="NAME">trianglesList.push</span><span class="PUNC">(</span><span class="NAME">partsArray</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">s</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1015</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1016</span> </span><span class="WHIT">				</span><span class="NAME">fanIndex</span><span class="PUNC">++</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1017</span> 
<span class='line'>1018</span> </span><span class="WHIT">				</span><span class="COMM">// last</span><span class="WHIT">
<span class='line'>1019</span> </span><span class="WHIT">				</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">s</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">s</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">partsArray</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">s</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1020</span> </span><span class="WHIT">				</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1021</span> </span><span class="WHIT">					</span><span class="NAME">trianglesList.push</span><span class="PUNC">(</span><span class="NAME">partsArray</span><span class="PUNC">[</span><span class="NAME">last</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">s</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1022</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1023</span> 
<span class='line'>1024</span> </span><span class="WHIT">				</span><span class="COMM">// if this is the first iteration, increase the fanIndex.</span><span class="WHIT">
<span class='line'>1025</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">firstTriangle</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1026</span> </span><span class="WHIT">				</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1027</span> </span><span class="WHIT">					</span><span class="NAME">fanIndex</span><span class="PUNC">++</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1028</span> </span><span class="WHIT">					</span><span class="NAME">firstTriangle</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1029</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1030</span> 
<span class='line'>1031</span> </span><span class="WHIT">				</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">s</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">s</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">partsArray</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">s</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1032</span> </span><span class="WHIT">				</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1033</span> </span><span class="WHIT">					</span><span class="NAME">trianglesList.push</span><span class="PUNC">(</span><span class="NAME">partsArray</span><span class="PUNC">[</span><span class="NAME">fanIndex</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">s</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1034</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1035</span> 
<span class='line'>1036</span> </span><span class="WHIT">				</span><span class="NAME">last</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">fanIndex</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1037</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1038</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1039</span> </span><span class="WHIT">		</span><span class="COMM">// overwrite rawFaces with the triangle faces, as if quads never existed.</span><span class="WHIT">
<span class='line'>1040</span> </span><span class="WHIT">		</span><span class="COMM">//rawFaces = trianglesList;				</span><span class="WHIT">
<span class='line'>1041</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">trianglesList</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1042</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1043</span> </span><span class="WHIT">	
<span class='line'>1044</span> 	
<span class='line'>1045</span> 	</span><span class="COMM">/**
<span class='line'>1046</span> 		@private
<span class='line'>1047</span> 		@param {XMLDocument} xmlObject
<span class='line'>1048</span> 		@param {String} libraryName
<span class='line'>1049</span> 		@param {String} elementName
<span class='line'>1050</span> 		@param {String} elementAttributeId
<span class='line'>1051</span> 	
<span class='line'>1052</span> 		@returns
<span class='line'>1053</span> 	*/</span><span class="WHIT">
<span class='line'>1054</span> </span><span class="WHIT">	</span><span class="NAME">this.findElementInLibrary</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">xmlObject</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">libraryName</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">elementName</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">elementAttributeId</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1055</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1056</span> </span><span class="WHIT">		</span><span class="COMM">// collada may have many listings of the same library.</span><span class="WHIT">
<span class='line'>1057</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">libraries</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">xmlObject.getElementsByTagName</span><span class="PUNC">(</span><span class="NAME">libraryName</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1058</span> </span><span class="WHIT">		
<span class='line'>1059</span> 		</span><span class="COMM">// for all the libraries in the &lt;collada> element</span><span class="WHIT">
<span class='line'>1060</span> </span><span class="WHIT">		</span><span class="KEYW">for</span><span class="PUNC">(</span><span class="NAME">libraryIter</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="NAME">libraryIter</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">libraries.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">libraryIter</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1061</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1062</span> </span><span class="WHIT">			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">elements</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">libraries</span><span class="PUNC">[</span><span class="NAME">libraryIter</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getElementsByTagName</span><span class="PUNC">(</span><span class="NAME">elementName</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1063</span> 
<span class='line'>1064</span> </span><span class="WHIT">			</span><span class="COMM">// for all the elements in each library.</span><span class="WHIT">
<span class='line'>1065</span> </span><span class="WHIT">			</span><span class="KEYW">for</span><span class="PUNC">(</span><span class="NAME">elementIter</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">elementIter</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">elements.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">elementIter</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1066</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1067</span> </span><span class="WHIT">				</span><span class="COMM">// found it</span><span class="WHIT">
<span class='line'>1068</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">elementAttributeId</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">elements</span><span class="PUNC">[</span><span class="NAME">elementIter</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="STRN">"id"</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1069</span> </span><span class="WHIT">				</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1070</span> </span><span class="WHIT">					</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">elements</span><span class="PUNC">[</span><span class="NAME">elementIter</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1071</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1072</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1073</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1074</span> </span><span class="WHIT">		</span><span class="COMM">// return null if it could not be found.</span><span class="WHIT">
<span class='line'>1075</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1076</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1077</span> 
<span class='line'>1078</span> 
<span class='line'>1079</span> </span><span class="WHIT">	</span><span class="COMM">/**
<span class='line'>1080</span> 		@private
<span class='line'>1081</span> 		@param {} xmlObject	
<span class='line'>1082</span> 		@param {String} nodeName
<span class='line'>1083</span> 		@param {String} attributeKey
<span class='line'>1084</span> 		@param {String} attributeValue
<span class='line'>1085</span> 		
<span class='line'>1086</span> 		@return 
<span class='line'>1087</span> 	*/</span><span class="WHIT">
<span class='line'>1088</span> </span><span class="WHIT">	</span><span class="NAME">this.getData</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">xmlObject</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">nodeName</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">attributeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">attributeValue</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1089</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1090</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">data</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">new</span><span class="WHIT"> </span><span class="NAME">Object</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1091</span> 
<span class='line'>1092</span> </span><span class="WHIT">		</span><span class="COMM">// find node that has 'src' value as id</span><span class="WHIT">
<span class='line'>1093</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">nsrc</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">c3dl.ColladaLoader.getNodeWithAttribute</span><span class="PUNC">(</span><span class="NAME">xmlObject</span><span class="PUNC">,</span><span class="STRN">"source"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"id"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">attributeValue</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1094</span> </span><span class="WHIT">		</span><span class="COMM">// go to the node's technique common</span><span class="WHIT">
<span class='line'>1095</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">tech_common</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">nsrc.getElementsByTagName</span><span class="PUNC">(</span><span class="STRN">"technique_common"</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1096</span> 
<span class='line'>1097</span> </span><span class="WHIT">		</span><span class="COMM">// go to its accessor</span><span class="WHIT">
<span class='line'>1098</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">accessor</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">tech_common.getElementsByTagName</span><span class="PUNC">(</span><span class="STRN">"accessor"</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1099</span> </span><span class="WHIT">		</span><span class="NAME">data.stride</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">accessor.getAttribute</span><span class="PUNC">(</span><span class="STRN">"stride"</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1100</span> </span><span class="WHIT">		
<span class='line'>1101</span> 		</span><span class="COMM">// get the source</span><span class="WHIT">
<span class='line'>1102</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">accessorSrc</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">accessor.getAttribute</span><span class="PUNC">(</span><span class="STRN">"source"</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">split</span><span class="PUNC">(</span><span class="STRN">"#"</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1103</span> </span><span class="WHIT">		
<span class='line'>1104</span> 		</span><span class="COMM">//</span><span class="WHIT">
<span class='line'>1105</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">float_array</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">c3dl.ColladaLoader.getNodeWithAttribute</span><span class="PUNC">(</span><span class="NAME">xmlObject</span><span class="PUNC">,</span><span class="STRN">"float_array"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"id"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">accessorSrc</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1106</span> 
<span class='line'>1107</span> </span><span class="WHIT">		</span><span class="COMM">//values in the DAE file are seperated with a space</span><span class="WHIT">
<span class='line'>1108</span> </span><span class="WHIT">		</span><span class="COMM">// don't use nodeValue since it will be broken up in 4096 chunks</span><span class="WHIT">
<span class='line'>1109</span> </span><span class="WHIT">		</span><span class="NAME">data.values</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.mergeChildData</span><span class="PUNC">(</span><span class="NAME">float_array.childNodes</span><span class="PUNC">)</span><span class="PUNC">.</span><span class="NAME">split</span><span class="PUNC">(</span><span class="STRN">" "</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1110</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">data</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1111</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1112</span> 
<span class='line'>1113</span> </span><span class="WHIT">	</span><span class="COMM">/**
<span class='line'>1114</span> 		@private
<span class='line'>1115</span> 		@param {Array} faces A 2D array which has indices.  Each index points
<span class='line'>1116</span> 		to a set of vertex, normal or texture coordinates.
<span class='line'>1117</span> 
<span class='line'>1118</span> 		&lt;pre>
<span class='line'>1119</span> 		// faces can look like this:
<span class='line'>1120</span> 		[
<span class='line'>1121</span> 			[0,0,0] , 
<span class='line'>1122</span> 			[1,0,1] , 
<span class='line'>1123</span> 			[2,0,2] 
<span class='line'>1124</span> 		]
<span class='line'>1125</span> 		// first value in each element is vertex index.
<span class='line'>1126</span> 		// second value is normal index.
<span class='line'>1127</span> 		// third value is uv index.
<span class='line'>1128</span> 		&lt;/pre>
<span class='line'>1129</span> 
<span class='line'>1130</span> 		@param {Array} array The array to expand. For a cube, the array of vertices
<span class='line'>1131</span> 		can look like:
<span class='line'>1132</span> 		
<span class='line'>1133</span> 		&lt;pre>
<span class='line'>1134</span> 		[1.00000,1.00000,-1.00000] , [1.00000,-1.00000,-1.00000] , [-1.00000,-1.00000,-1.00000] 
<span class='line'>1135</span> 		&lt;/pre>
<span class='line'>1136</span> 
<span class='line'>1137</span> 
<span class='line'>1138</span> 		@param offset Refers to the component we are interested in within an array
<span class='line'>1139</span> 		in the faces array.  Since the faces array has indices for verts, normals and texcoords,
<span class='line'>1140</span> 		using a different index gets us a index which is a 0 based index into a list of 
<span class='line'>1141</span> 		coordinates.
<span class='line'>1142</span> 		
<span class='line'>1143</span> 		&lt;pre>
<span class='line'>1144</span> 		here is a faces array.  If we used offset=2, we would get the following indices:
<span class='line'>1145</span> 		[0,0,0] , [1,0,1] , [2,0,2] 
<span class='line'>1146</span>            ^         ^         ^
<span class='line'>1147</span> 		&lt;/pre>
<span class='line'>1148</span> 		
<span class='line'>1149</span> 		@param {int} numComponentsToExpand 
<span class='line'>1150</span> 	*/</span><span class="WHIT">
<span class='line'>1151</span> </span><span class="WHIT">	</span><span class="NAME">this.expandFaces</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">faces</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">array</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">offset</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">numComponentsToExpand</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1152</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1153</span> </span><span class="WHIT">		</span><span class="COMM">// this is a single dimensional array which hold expanded values.</span><span class="WHIT">
<span class='line'>1154</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">expandedArray</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1155</span> </span><span class="WHIT">		
<span class='line'>1156</span> 		</span><span class="COMM">// in the nested loop, we divide the instructions into parts to</span><span class="WHIT">
<span class='line'>1157</span> </span><span class="WHIT">		</span><span class="COMM">// make it easier to read, but don't allocate these varialbes everytime</span><span class="WHIT">
<span class='line'>1158</span> </span><span class="WHIT">		</span><span class="COMM">// the loop is executed, so declare them here. This speeds up the parser</span><span class="WHIT">
<span class='line'>1159</span> </span><span class="WHIT">		</span><span class="COMM">// quite a bit.</span><span class="WHIT">
<span class='line'>1160</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">face</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1161</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">coordIndex</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1162</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">coord</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1163</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">floatValue</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1164</span> 
<span class='line'>1165</span> </span><span class="WHIT">		</span><span class="COMM">// for all the faces</span><span class="WHIT">
<span class='line'>1166</span> </span><span class="WHIT">		</span><span class="COMM">//  [0,0,0] ,   [1,0,1] ,   [2,0,2] </span><span class="WHIT">
<span class='line'>1167</span> </span><span class="WHIT">		</span><span class="COMM">//  \    /      \    /      \    /  </span><span class="WHIT">
<span class='line'>1168</span> </span><span class="WHIT">		</span><span class="COMM">//    \/          \/          \/</span><span class="WHIT">
<span class='line'>1169</span> </span><span class="WHIT">		</span><span class="COMM">// currFace=0   currFace=1    ...</span><span class="WHIT">
<span class='line'>1170</span> </span><span class="WHIT">		</span><span class="KEYW">for</span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currFace</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currFace</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">faces.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currFace</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1171</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1172</span> </span><span class="WHIT">			</span><span class="COMM">// have to be scalar, no arrays</span><span class="WHIT">
<span class='line'>1173</span> </span><span class="WHIT">			
<span class='line'>1174</span> 			</span><span class="COMM">// each element in the faces array is another array. That second array</span><span class="WHIT">
<span class='line'>1175</span> </span><span class="WHIT">			</span><span class="COMM">// hold components.  We iterate </span><span class="WHIT">
<span class='line'>1176</span> </span><span class="WHIT">			</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currComp</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currComp</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">numComponentsToExpand</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currComp</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1177</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1178</span> </span><span class="WHIT">				</span><span class="COMM">// go to a particular face:</span><span class="WHIT">
<span class='line'>1179</span> </span><span class="WHIT">				</span><span class="COMM">// [3, 1, 4]</span><span class="WHIT">
<span class='line'>1180</span> </span><span class="WHIT">				</span><span class="NAME">face</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">faces</span><span class="PUNC">[</span><span class="NAME">currFace</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1181</span> </span><span class="WHIT">			
<span class='line'>1182</span> 				
<span class='line'>1183</span> 				</span><span class="COMM">// we might be dealing with verts, norms or textures, each has a different offset.</span><span class="WHIT">
<span class='line'>1184</span> </span><span class="WHIT">				</span><span class="COMM">// then go to a particular value inside denoted by the offset.</span><span class="WHIT">
<span class='line'>1185</span> </span><span class="WHIT">				</span><span class="COMM">// [3, 1, 4]</span><span class="WHIT">
<span class='line'>1186</span> </span><span class="WHIT">				</span><span class="COMM">//        ^</span><span class="WHIT">
<span class='line'>1187</span> </span><span class="WHIT">				</span><span class="COMM">// offset = 2 for tex</span><span class="WHIT">
<span class='line'>1188</span> </span><span class="WHIT">				</span><span class="COMM">// 4 is an index which refers to the 4th set of tex coords.</span><span class="WHIT">
<span class='line'>1189</span> </span><span class="WHIT">				</span><span class="COMM">// something like:</span><span class="WHIT">
<span class='line'>1190</span> </span><span class="WHIT">				</span><span class="COMM">// ["1.0", "0.0"] </span><span class="WHIT">
<span class='line'>1191</span> </span><span class="WHIT">				</span><span class="NAME">coordIndex</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">face</span><span class="PUNC">[</span><span class="NAME">offset</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1192</span> </span><span class="WHIT">				
<span class='line'>1193</span> 				</span><span class="COMM">// coord is a vertex coord, normal or uv coord retrieved from the</span><span class="WHIT">
<span class='line'>1194</span> </span><span class="WHIT">				</span><span class="COMM">// 'array' array.</span><span class="WHIT">
<span class='line'>1195</span> </span><span class="WHIT">				</span><span class="COMM">//</span><span class="WHIT">
<span class='line'>1196</span> </span><span class="WHIT">				</span><span class="COMM">// ["29.4787", "0", "50.5349"]  -> array[0]</span><span class="WHIT">
<span class='line'>1197</span> </span><span class="WHIT">				</span><span class="COMM">// ["29.4787", "0", "50.5349"]  -> array[1]</span><span class="WHIT">
<span class='line'>1198</span> </span><span class="WHIT">				</span><span class="COMM">// ...</span><span class="WHIT">
<span class='line'>1199</span> </span><span class="WHIT">				</span><span class="COMM">// this is done for each component, for textures, we have 2 components.</span><span class="WHIT">
<span class='line'>1200</span> </span><span class="WHIT">				</span><span class="COMM">// for normals, we have 3.</span><span class="WHIT">
<span class='line'>1201</span> </span><span class="WHIT">				</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">coordIndex</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1202</span> </span><span class="WHIT">				</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1203</span> </span><span class="WHIT">					</span><span class="NAME">coord</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">array</span><span class="PUNC">[</span><span class="NAME">coordIndex</span><span class="PUNC">]</span><span class="PUNC">[</span><span class="NAME">currComp</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1204</span> </span><span class="WHIT">				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1205</span> </span><span class="WHIT">				
<span class='line'>1206</span> 				</span><span class="COMM">// we have the value, but its a string so we have to convert it to a number.</span><span class="WHIT">
<span class='line'>1207</span> </span><span class="WHIT">				</span><span class="NAME">floatVal</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parseFloat</span><span class="PUNC">(</span><span class="NAME">coord</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1208</span> </span><span class="WHIT">			
<span class='line'>1209</span> 				</span><span class="COMM">// insert that value into the 1d array.</span><span class="WHIT">
<span class='line'>1210</span> </span><span class="WHIT">				</span><span class="NAME">expandedArray.push</span><span class="PUNC">(</span><span class="NAME">floatVal</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1211</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1212</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1213</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">expandedArray</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1214</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1215</span> 
<span class='line'>1216</span> </span><span class="WHIT">	</span><span class="COMM">/**
<span class='line'>1217</span> 		@private
<span class='line'>1218</span> 		Loading is done once all the nodes in the .DAE file have been created and placed
<span class='line'>1219</span> 		into the ModelManager.
<span class='line'>1220</span> 		
<span class='line'>1221</span> 		@returns {bool} true if loading is done, false otherwise. 
<span class='line'>1222</span> 	*/</span><span class="WHIT">
<span class='line'>1223</span> </span><span class="WHIT">	</span><span class="NAME">this.doneLoading</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1224</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1225</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">this.done</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1226</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1227</span> </span><span class="WHIT">	
<span class='line'>1228</span> 	</span><span class="COMM">/**
<span class='line'>1229</span> 		@private
<span class='line'>1230</span> 
<span class='line'>1231</span> 		get data from blinn, phong, lambert node
<span class='line'>1232</span> 		
<span class='line'>1233</span> 		@param {}
<span class='line'>1234</span> 		@param {String} str
<span class='line'>1235</span> 	*/</span><span class="WHIT">
<span class='line'>1236</span> </span><span class="WHIT">	</span><span class="NAME">this.getColor</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">node</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">str</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1237</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1238</span> </span><span class="WHIT">		</span><span class="COMM">// ambient, diffuse, specular, etc.</span><span class="WHIT">
<span class='line'>1239</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">component</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">node</span><span class="WHIT"> </span><span class="PUNC">!=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="WHIT"> </span><span class="PUNC">?</span><span class="WHIT"> </span><span class="NAME">node.getElementsByTagName</span><span class="PUNC">(</span><span class="NAME">str</span><span class="PUNC">)</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="WHIT"> </span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1240</span> </span><span class="WHIT">		
<span class='line'>1241</span> 		</span><span class="COMM">// if the component has a reference parameter, ignore it for now.</span><span class="WHIT">
<span class='line'>1242</span> </span><span class="WHIT">		</span><span class="COMM">// that component will not be used in the calculations.</span><span class="WHIT">
<span class='line'>1243</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">returnValue</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1244</span> </span><span class="WHIT">		
<span class='line'>1245</span> 		</span><span class="COMM">// if the component is present (ambient, diffuse, specular)</span><span class="WHIT">
<span class='line'>1246</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">component</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1247</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">			
<span class='line'>1248</span> 			</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">value</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">this.getChoice</span><span class="PUNC">(</span><span class="NAME">component</span><span class="PUNC">,</span><span class="PUNC">[</span><span class="STRN">"color"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"float"</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">"texture"</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1249</span> </span><span class="WHIT">				
<span class='line'>1250</span> 			</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">value.nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">"color"</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1251</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1252</span> </span><span class="WHIT">				</span><span class="NAME">returnValue</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1253</span> </span><span class="WHIT">				</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currNode</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">value.childNodes.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currNode</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1254</span> </span><span class="WHIT">				</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1255</span> </span><span class="WHIT">					</span><span class="NAME">returnValue</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">value.childNodes</span><span class="PUNC">[</span><span class="NAME">currNode</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">nodeValue</span><span class="PUNC">;</span><span class="WHIT">	
<span class='line'>1256</span> 				</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1257</span> </span><span class="WHIT">				</span><span class="NAME">returnValue</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">returnValue.split</span><span class="PUNC">(</span><span class="STRN">" "</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1258</span> </span><span class="WHIT">                </span><span class="NAME">returnValue</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="NAME">parseFloat</span><span class="PUNC">(</span><span class="NAME">returnValue</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="NAME">parseFloat</span><span class="PUNC">(</span><span class="NAME">returnValue</span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">,</span><span class="NAME">parseFloat</span><span class="PUNC">(</span><span class="NAME">returnValue</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">			
<span class='line'>1259</span> 				</span><span class="NAME">returnValue</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">returnValue.slice</span><span class="PUNC">(</span><span class="NUMB">0</span><span class="PUNC">,</span><span class="NUMB">3</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1260</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1261</span> </span><span class="WHIT">			</span><span class="COMM">//</span><span class="WHIT">
<span class='line'>1262</span> </span><span class="WHIT">			</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">value.nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">"float"</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1263</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1264</span> </span><span class="WHIT">				</span><span class="NAME">returnValue</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">parseFloat</span><span class="PUNC">(</span><span class="NAME">value.childNodes</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">nodeValue</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1265</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1266</span> </span><span class="WHIT">			</span><span class="COMM">// </span><span class="WHIT">
<span class='line'>1267</span> </span><span class="WHIT">			</span><span class="KEYW">else</span><span class="WHIT"> </span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">value.nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="STRN">"texture"</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1268</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1269</span> </span><span class="WHIT">				</span><span class="NAME">returnValue</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="NUMB">1</span><span class="PUNC">,</span><span class="NUMB">1</span><span class="PUNC">,</span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1270</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1271</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1272</span> 
<span class='line'>1273</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">returnValue</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1274</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1275</span> </span><span class="WHIT">	
<span class='line'>1276</span> 	
<span class='line'>1277</span> 	
<span class='line'>1278</span> 	</span><span class="COMM">/**
<span class='line'>1279</span> 		@private
<span class='line'>1280</span> 		When reading data in between tags, 
<span class='line'>1281</span> 		
<span class='line'>1282</span> 		There tends to be a lot of data between tags such as &lt;float_array>
<span class='line'>1283</span> 		&lt;float_array id="Teapot-mesh-positions-array" count="1590">29.4787 0 50.5349 ..... 34.093 &lt;/float_array>
<span class='line'>1284</span> 		
<span class='line'>1285</span> 		We can't just read the node value contents because it is broken up into 4096 byte chunks. So 
<span class='line'>1286</span> 		we use this function to merge all the chunks together.
<span class='line'>1287</span> 
<span class='line'>1288</span> 		@param {String} childNodes
<span class='line'>1289</span> 
<span class='line'>1290</span> 		@returns
<span class='line'>1291</span> 	*/</span><span class="WHIT">
<span class='line'>1292</span> </span><span class="WHIT">	</span><span class="NAME">this.mergeChildData</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">childNodes</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1293</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1294</span> </span><span class="WHIT">		</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">values</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1295</span> </span><span class="WHIT">		</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">currNode</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currNode</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">childNodes.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">currNode</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1296</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1297</span> </span><span class="WHIT">			</span><span class="NAME">values</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">childNodes</span><span class="PUNC">[</span><span class="NAME">currNode</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">nodeValue</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1298</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1299</span> </span><span class="WHIT">		
<span class='line'>1300</span> 		</span><span class="COMM">// there are some 3d authoring tools which place a trailing space after a long set of data.</span><span class="WHIT">
<span class='line'>1301</span> </span><span class="WHIT">		</span><span class="COMM">// for example:</span><span class="WHIT">
<span class='line'>1302</span> </span><span class="WHIT">		</span><span class="COMM">//</span><span class="WHIT">
<span class='line'>1303</span> </span><span class="WHIT">		</span><span class="COMM">// &lt;float_array id="Teapot-mesh-positions-array" count="1590">29.4787 0 50.5349 ..... 34.093 &lt;/float_array></span><span class="WHIT">
<span class='line'>1304</span> </span><span class="WHIT">		</span><span class="COMM">//</span><span class="WHIT">
<span class='line'>1305</span> </span><span class="WHIT">		</span><span class="COMM">// the trailing space causes problems as when the string is split, an undefined value</span><span class="WHIT">
<span class='line'>1306</span> </span><span class="WHIT">		</span><span class="COMM">// is placed at the end of the array.  So we will get rid of any trailing spaces here.</span><span class="WHIT">
<span class='line'>1307</span> </span><span class="WHIT">		</span><span class="COMM">//</span><span class="WHIT">
<span class='line'>1308</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">values.replace</span><span class="PUNC">(</span><span class="REGX">/\s+$/</span><span class="PUNC">,</span><span class="STRN">''</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1309</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1310</span> </span><span class="WHIT">	
<span class='line'>1311</span> 	
<span class='line'>1312</span> 	
<span class='line'>1313</span> 	</span><span class="COMM">/**
<span class='line'>1314</span> 		@private
<span class='line'>1315</span> 		Get the first child of type 'nodeName' of a element 'searchNode'.
<span class='line'>1316</span> 
<span class='line'>1317</span> 		@param {Object Element} searchNode - the element to search.
<span class='line'>1318</span> 		@param {String} nodeName - the node to search for.
<span class='line'>1319</span> 		
<span class='line'>1320</span> 		@returns 
<span class='line'>1321</span> 	*/</span><span class="WHIT">
<span class='line'>1322</span> </span><span class="WHIT">	</span><span class="NAME">this.getFirstChildByNodeName</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">searchNode</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">nodeName</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1323</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1324</span> </span><span class="WHIT">		</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">=</span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">searchNode.childNodes.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1325</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1326</span> </span><span class="WHIT">			</span><span class="COMM">// found it!</span><span class="WHIT">
<span class='line'>1327</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">searchNode.childNodes</span><span class="PUNC">[</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1328</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1329</span> </span><span class="WHIT">				</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">searchNode.childNodes</span><span class="PUNC">[</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1330</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1331</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1332</span> </span><span class="WHIT">		</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1333</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1334</span> 
<span class='line'>1335</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1336</span> 
<span class='line'>1337</span> 
<span class='line'>1338</span> </span><span class="COMM">/**
<span class='line'>1339</span> 	@private	
<span class='line'>1340</span> 	
<span class='line'>1341</span> 	static method of collada loader. 
<span class='line'>1342</span> 	
<span class='line'>1343</span> 	@param {} xmlObject
<span class='line'>1344</span> 	@param {String} nodeName
<span class='line'>1345</span> 	@param {String} attributeKey
<span class='line'>1346</span> 	@param {String} attributeValue
<span class='line'>1347</span> 	
<span class='line'>1348</span> 	@returns 
<span class='line'>1349</span> */</span><span class="WHIT">
<span class='line'>1350</span> </span><span class="NAME">c3dl.ColladaLoader.getNodeWithAttribute</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">xmlObject</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">nodeName</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">attributeKey</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">attributeValue</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1351</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1352</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">nodeFound</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1353</span> </span><span class="WHIT">	
<span class='line'>1354</span> 	</span><span class="COMM">// go to the root of the XML</span><span class="WHIT">
<span class='line'>1355</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">root</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">xmlObject.documentElement</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1356</span> 
<span class='line'>1357</span> </span><span class="WHIT">	</span><span class="COMM">// get all the tags names 'nodeName'</span><span class="WHIT">
<span class='line'>1358</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">elements</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">root.getElementsByTagName</span><span class="PUNC">(</span><span class="NAME">nodeName</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1359</span> </span><span class="WHIT">	
<span class='line'>1360</span> 	</span><span class="COMM">// we might have a few tags, we need to find the one with the id specified</span><span class="WHIT">
<span class='line'>1361</span> </span><span class="WHIT">	</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">elements.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1362</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1363</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">elements</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">getAttribute</span><span class="PUNC">(</span><span class="NAME">attributeKey</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">attributeValue</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1364</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1365</span> </span><span class="WHIT">			</span><span class="NAME">nodeFound</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">elements</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT"> 
<span class='line'>1366</span> 		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1367</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1368</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">nodeFound</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1369</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1370</span> 
<span class='line'>1371</span> 
<span class='line'>1372</span> </span><span class="COMM">/**
<span class='line'>1373</span> 	@private
<span class='line'>1374</span> 	Get the child nodes of searchNode which have the name 'nodeName'.
<span class='line'>1375</span> 	This funciton is not recursive.  It only returns the &lt;b>direct&lt;/b> children.
<span class='line'>1376</span> 	
<span class='line'>1377</span> 	@param {String} searchNode - the node to search.
<span class='line'>1378</span> 	@param {String} nodeName - the nodes to search for.
<span class='line'>1379</span> 
<span class='line'>1380</span> 	@returns {Array} array of node elements.
<span class='line'>1381</span> */</span><span class="WHIT">
<span class='line'>1382</span> </span><span class="NAME">c3dl.ColladaLoader.getChildNodesByNodeName</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">searchNode</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">nodeName</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1383</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1384</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">children</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1385</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">foundOne</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1386</span> 
<span class='line'>1387</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">searchNode.childNodes.length</span><span class="WHIT"> </span><span class="PUNC">></span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1388</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1389</span> </span><span class="WHIT">		</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">searchNode.childNodes.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1390</span> </span><span class="WHIT">		</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1391</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">searchNode.childNodes</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">nodeName</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">nodeName</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1392</span> </span><span class="WHIT">			</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1393</span> </span><span class="WHIT">				</span><span class="NAME">children.push</span><span class="PUNC">(</span><span class="WHIT"> </span><span class="NAME">searchNode.childNodes</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1394</span> </span><span class="WHIT">				</span><span class="NAME">foundOne</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1395</span> </span><span class="WHIT">			</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1396</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1397</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1398</span> 
<span class='line'>1399</span> </span><span class="WHIT">	</span><span class="COMM">// somehow need to specify if non were found, so </span><span class="WHIT">
<span class='line'>1400</span> </span><span class="WHIT">	</span><span class="COMM">// send back a null if that's the case.</span><span class="WHIT">
<span class='line'>1401</span> </span><span class="WHIT">	</span><span class="KEYW">if</span><span class="PUNC">(</span><span class="NAME">foundOne</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="KEYW">false</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1402</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1403</span> </span><span class="WHIT">		</span><span class="NAME">children</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1404</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1405</span> 
<span class='line'>1406</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">children</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1407</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1408</span> 
<span class='line'>1409</span> 
<span class='line'>1410</span> 
<span class='line'>1411</span> </span><span class="COMM">/**
<span class='line'>1412</span> 	@private
<span class='line'>1413</span> 	static method of c3dl.ColladaLoader
<span class='line'>1414</span> 	
<span class='line'>1415</span> 	Turn a series of strings seperated by 'delimiter' into float values.
<span class='line'>1416</span> 	used when we need to convert &lt;translate>0.0 0.0 0.0&lt;/translate> into float
<span class='line'>1417</span> 	values.
<span class='line'>1418</span> 	
<span class='line'>1419</span> 	@param {String} numbers A string which contains numbers such as "1.0 0.0 1.0 0.0       0.0 1.0 ..." note the spaces.
<span class='line'>1420</span> 	@param {String} delimeter A string which is being used to separate the numbers.
<span class='line'>1421</span> */</span><span class="WHIT">
<span class='line'>1422</span> </span><span class="NAME">c3dl.ColladaLoader.stringsToFloats</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="KEYW">function</span><span class="PUNC">(</span><span class="NAME">numbers</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">delimeter</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1423</span> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1424</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">floatValues</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">[</span><span class="PUNC">]</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1425</span> </span><span class="WHIT">	
<span class='line'>1426</span> 	</span><span class="COMM">// Get rid of leading and trailing spaces so they don't interfere with out split().</span><span class="WHIT">
<span class='line'>1427</span> </span><span class="WHIT">		
<span class='line'>1428</span> 	</span><span class="COMM">// remove leading whitespace</span><span class="WHIT">
<span class='line'>1429</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">trimmedNumbers</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">numbers.replace</span><span class="PUNC">(</span><span class="REGX">/^\s+/</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">''</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1430</span> </span><span class="WHIT">	
<span class='line'>1431</span> 	</span><span class="COMM">// remove trailing whitespace</span><span class="WHIT">
<span class='line'>1432</span> </span><span class="WHIT">	</span><span class="NAME">trimmedNumbers</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">trimmedNumbers.replace</span><span class="PUNC">(</span><span class="REGX">/\s+$/</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="STRN">''</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1433</span> </span><span class="WHIT">	
<span class='line'>1434</span> 	</span><span class="COMM">// remove superfluous whitespace between numbers</span><span class="WHIT">
<span class='line'>1435</span> </span><span class="WHIT">	</span><span class="COMM">// find one or more instances of whitespace and replace with a single space.</span><span class="WHIT">
<span class='line'>1436</span> </span><span class="WHIT">	</span><span class="NAME">trimmedNumbers</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">trimmedNumbers.replace</span><span class="PUNC">(</span><span class="REGX">/\s+/g</span><span class="PUNC">,</span><span class="STRN">' '</span><span class="WHIT"> </span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1437</span> </span><span class="WHIT">	
<span class='line'>1438</span> 	</span><span class="COMM">// split each number into an element of an array, but they are still</span><span class="WHIT">
<span class='line'>1439</span> </span><span class="WHIT">	</span><span class="COMM">// strings, so convert them to float.</span><span class="WHIT">
<span class='line'>1440</span> </span><span class="WHIT">	</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">strValues</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">trimmedNumbers.split</span><span class="PUNC">(</span><span class="NAME">delimeter</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1441</span> 
<span class='line'>1442</span> </span><span class="WHIT">	</span><span class="KEYW">for</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="KEYW">var</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NUMB">0</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">&lt;</span><span class="WHIT"> </span><span class="NAME">strValues.length</span><span class="PUNC">;</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">++</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'>1443</span> </span><span class="WHIT">	</span><span class="PUNC">{</span><span class="WHIT">
<span class='line'>1444</span> </span><span class="WHIT">		</span><span class="NAME">floatValues.push</span><span class="PUNC">(</span><span class="NAME">parseFloat</span><span class="PUNC">(</span><span class="NAME">strValues</span><span class="PUNC">[</span><span class="NAME">i</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1445</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1446</span> 
<span class='line'>1447</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">floatValues</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'>1448</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'>1449</span> </span></pre></body></html>